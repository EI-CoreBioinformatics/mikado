<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Mikado.picking.picker &mdash; Mikado 19 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '19',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Mikado 19 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Mikado.picking.picker</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># coding=utf-8</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module defines the Picker class, which is the main workhorse for Mikado.py pick.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">handlers</span> <span class="k">as</span> <span class="n">logging_handlers</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="kn">import</span> <span class="n">create_engine</span>  <span class="c1"># SQLAlchemy/DB imports</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.session</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.pool</span> <span class="kn">import</span> <span class="n">QueuePool</span> <span class="k">as</span> <span class="n">SqlPool</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">import</span> <span class="nn">sqlalchemy.exc</span>
<span class="kn">from</span> <span class="nn">..utilities</span> <span class="kn">import</span> <span class="n">path_join</span>
<span class="kn">from</span> <span class="nn">..utilities.log_utils</span> <span class="kn">import</span> <span class="n">formatter</span>
<span class="kn">from</span> <span class="nn">..parsers.GTF</span> <span class="kn">import</span> <span class="n">GTF</span>
<span class="kn">from</span> <span class="nn">..parsers.GFF</span> <span class="kn">import</span> <span class="n">GFF3</span>
<span class="kn">from</span> <span class="nn">..serializers.blast_serializer</span> <span class="kn">import</span> <span class="n">Hit</span><span class="p">,</span> <span class="n">Query</span>
<span class="kn">from</span> <span class="nn">..serializers.junction</span> <span class="kn">import</span> <span class="n">Junction</span><span class="p">,</span> <span class="n">Chrom</span>
<span class="kn">from</span> <span class="nn">..serializers.orf</span> <span class="kn">import</span> <span class="n">Orf</span>
<span class="kn">from</span> <span class="nn">..loci.superlocus</span> <span class="kn">import</span> <span class="n">Superlocus</span><span class="p">,</span> <span class="n">Transcript</span>
<span class="kn">from</span> <span class="nn">..configuration.configurator</span> <span class="kn">import</span> <span class="n">to_json</span>  <span class="c1"># Necessary for nosetests</span>
<span class="kn">from</span> <span class="nn">..utilities</span> <span class="kn">import</span> <span class="n">dbutils</span><span class="p">,</span> <span class="n">merge_partial</span>
<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="n">UnsortedInput</span><span class="p">,</span> <span class="n">InvalidJson</span><span class="p">,</span> <span class="n">InvalidTranscript</span>
<span class="kn">from</span> <span class="nn">.loci_processer</span> <span class="kn">import</span> <span class="n">analyse_locus</span><span class="p">,</span> <span class="n">LociProcesser</span><span class="p">,</span> <span class="n">merge_loci</span>
<span class="kn">import</span> <span class="nn">multiprocessing.managers</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">import</span> <span class="nn">pickle</span>


<span class="c1"># pylint: disable=too-many-instance-attributes</span>
<div class="viewcode-block" id="Picker"><a class="viewcode-back" href="../../../Mikado.picking.html#Mikado.picking.picker.Picker">[docs]</a><span class="k">class</span> <span class="nc">Picker</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is used to launch the main Mikado.py pipeline. Its purpose is to parse</span>
<span class="sd">    an input sorted annotation file, locate the loci, and perform the selection analysis</span>
<span class="sd">    using the parameters provided in the input configuration file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># @profile</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_conf</span><span class="p">,</span> <span class="n">commandline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Constructor. It takes a single argument as input - the JSON/YAML configuration,</span>
<span class="sd">        prepared by the json_utils functions.</span>

<span class="sd">        :param json_conf: Either a configuration dictionary or the configuration file.</span>
<span class="sd">        :type json_conf: str,dict</span>

<span class="sd">        :param commandline: optional, the commandline used to start the program</span>
<span class="sd">        :type commandline: str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Mock variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_writer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&quot;WARN&quot;</span>

        <span class="c1"># Things that have to be deleted upon serialisation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">not_pickable</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;queue_logger&quot;</span><span class="p">,</span> <span class="s2">&quot;manager&quot;</span><span class="p">,</span> <span class="s2">&quot;printer_process&quot;</span><span class="p">,</span>
                             <span class="s2">&quot;log_process&quot;</span><span class="p">,</span> <span class="s2">&quot;pool&quot;</span><span class="p">,</span> <span class="s2">&quot;main_logger&quot;</span><span class="p">,</span>
                             <span class="s2">&quot;log_handler&quot;</span><span class="p">,</span> <span class="s2">&quot;log_writer&quot;</span><span class="p">,</span> <span class="s2">&quot;logger&quot;</span><span class="p">,</span> <span class="s2">&quot;engine&quot;</span><span class="p">]</span>

        <span class="c1"># Now we start the real work</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_conf</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">json_conf</span><span class="p">)</span>
            <span class="n">json_conf</span> <span class="o">=</span> <span class="n">to_json</span><span class="p">(</span><span class="n">json_conf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_conf</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">commandline</span> <span class="o">=</span> <span class="n">commandline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span> <span class="o">=</span> <span class="n">json_conf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regressor</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">procs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;procs&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_input</span><span class="p">()</span>  <span class="c1"># Check the input file</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;subloci_out&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sub_out</span> <span class="o">=</span> <span class="n">path_join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;output_dir&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;subloci_out&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sub_out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;monoloci_out&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monolocus_out</span> <span class="o">=</span> <span class="n">path_join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;output_dir&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;monoloci_out&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monolocus_out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locus_out</span> <span class="o">=</span> <span class="n">path_join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;output_dir&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;loci_out&quot;</span><span class="p">])</span>
        <span class="c1"># pylint: disable=no-member</span>
        <span class="n">multiprocessing</span><span class="o">.</span><span class="n">set_start_method</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;multiprocessing_method&quot;</span><span class="p">],</span>
                                         <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printer_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_logger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Multiprocessing method: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;multiprocessing_method&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;scoring_file&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.pickle&quot;</span><span class="p">,</span> <span class="s2">&quot;.model&quot;</span><span class="p">)):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;scoring_file&quot;</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">forest</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">regressor</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">forest</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regressor</span><span class="p">,</span> <span class="n">RandomForestRegressor</span><span class="p">):</span>
                <span class="n">exc</span><span class="o">=</span><span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid regressor provided, type: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regressor</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regressor</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># pylint: enable=no-member</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db_connection</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
            <span class="n">dbutils</span><span class="o">.</span><span class="n">create_connector</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger_queue_handler</span> <span class="o">=</span> <span class="n">logging_handlers</span><span class="o">.</span><span class="n">QueueHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_queue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;parser&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger_queue_handler</span><span class="p">)</span>

        <span class="c1"># Configure SQL logging</span>
        <span class="n">sqllogger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;sqlalchemy.engine&quot;</span><span class="p">)</span>
        <span class="c1"># if json_conf[&quot;log_settings&quot;][&quot;log_level&quot;] == &quot;DEBUG&quot;:</span>
        <span class="c1">#     sqllogger.setLevel(&quot;DEBUG&quot;)</span>
        <span class="c1"># else:</span>
        <span class="n">sqllogger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;log_settings&quot;</span><span class="p">][</span><span class="s2">&quot;sql_level&quot;</span><span class="p">])</span>
        <span class="n">sqllogger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger_queue_handler</span><span class="p">)</span>

        <span class="c1"># We need to set this to the lowest possible level,</span>
        <span class="c1"># otherwise we overwrite the global configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;log_settings&quot;</span><span class="p">][</span><span class="s2">&quot;log_level&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;single_thread&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># Reset threads to 1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;procs&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Reset number of threads to 1 as requested&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">procs</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;procs&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;single_thread&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;preload&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">procs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Preloading using multiple threads can be extremely </span><span class="se">\</span>
<span class="s2">memory intensive, proceed with caution!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">locus_out</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidJson</span><span class="p">(</span>
                <span class="s2">&quot;No output prefix specified for the final loci. Key: </span><span class="se">\&quot;</span><span class="s2">loci_out</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># self.printer_process = Process(target=self.printer)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_pool</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="Picker.define_input"><a class="viewcode-back" href="../../../Mikado.picking.html#Mikado.picking.picker.Picker.define_input">[docs]</a>    <span class="k">def</span> <span class="nf">define_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function to check that the input file exists and is valid. It returns the parser.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gtf&quot;</span><span class="p">):</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">GTF</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">GFF3</span>

        <span class="n">verified</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">parser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">header</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="n">verified</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">verified</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidJson</span><span class="p">(</span>
                <span class="s2">&quot;Invalid input file: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">parser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="Picker.setup_shm_db"><a class="viewcode-back" href="../../../Mikado.picking.html#Mikado.picking.picker.Picker.setup_shm_db">[docs]</a>    <span class="k">def</span> <span class="nf">setup_shm_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will copy the SQLite input DB into memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copy into a SHM db: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm_shared&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copying the DB into memory&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;db_settings&quot;</span><span class="p">][</span><span class="s2">&quot;dbtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sqlite&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;preload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm_db&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm_db&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s2">&quot;/dev/shm/&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm_db&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm_shared&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Create temporary file</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.db&quot;</span><span class="p">,</span>
                                       <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/dev/shm/&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm_db&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm_db&quot;</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copying {0} into {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;db_settings&quot;</span><span class="p">][</span><span class="s2">&quot;db&quot;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm_db&quot;</span><span class="p">]))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;db_settings&quot;</span><span class="p">][</span><span class="s2">&quot;db&quot;</span><span class="p">],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm_db&quot;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="n">PermissionError</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="sd">&quot;&quot;&quot;Permission to write on /dev/shm denied.</span>
<span class="sd">                            Back to using the DB on disk.&quot;&quot;&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> exists already. Doing nothing.&quot;</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm_db&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DB copied into memory&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Picker.setup_logger"><a class="viewcode-back" href="../../../Mikado.picking.html#Mikado.picking.picker.Picker.setup_logger">[docs]</a>    <span class="k">def</span> <span class="nf">setup_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This function sets up the logger for the class.</span>
<span class="sd">        It creates the instance attribute &quot;log_writer&quot;, which is itself a</span>
<span class="sd">        logging.handlers.QueueListener instance listening on the logging_queue</span>
<span class="sd">        instance attribute (which is a normal mp.Manager.Queue instance).&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">formatter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;main_logger&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;output_dir&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">PermissionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to create the output directory!&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;The specified output directory </span><span class="si">%s</span><span class="s2"> exists and is not a file; aborting&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;output_dir&quot;</span><span class="p">])</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;The specified output directory </span><span class="si">%s</span><span class="s2"> exists and is not a file; aborting&quot;</span> <span class="o">%</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;output_dir&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;listener&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;log&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;log&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;stream&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span>
                <span class="n">path_join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;output_dir&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;log&quot;</span><span class="p">]),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="c1"># For the main logger I want to keep it at the &quot;INFO&quot; level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;log_settings&quot;</span><span class="p">][</span><span class="s2">&quot;log_level&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">==</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_handler</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Begun analysis of {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandline</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Command line: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commandline</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Analysis launched directly, without using the launch script.&quot;</span><span class="p">)</span>

        <span class="c1"># Create the shared DB if necessary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_shm_db</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;chimera_split&quot;</span><span class="p">][</span><span class="s2">&quot;blast_check&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;log_settings&quot;</span><span class="p">][</span><span class="s2">&quot;log_level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">:</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="n">dbutils</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="p">)</span>
            <span class="n">smaker</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">()</span>
            <span class="n">smaker</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">smaker</span><span class="p">()</span>

            <span class="n">evalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;chimera_split&quot;</span><span class="p">][</span><span class="s2">&quot;blast_params&quot;</span><span class="p">][</span><span class="s2">&quot;evalue&quot;</span><span class="p">]</span>
            <span class="n">queries_with_hits</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">Hit</span><span class="o">.</span><span class="n">query_id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Hit</span><span class="o">.</span><span class="n">evalue</span> <span class="o">&lt;=</span> <span class="n">evalue</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="n">total_queries</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Query</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Queries with at least one hit at evalue&lt;=</span><span class="si">%f</span><span class="s2">: </span><span class="si">%d</span><span class="s2"> out of </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%f%%</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">evalue</span><span class="p">,</span>
                <span class="n">queries_with_hits</span><span class="p">,</span>
                <span class="n">total_queries</span><span class="p">,</span>
                <span class="mi">0</span> <span class="k">if</span> <span class="n">total_queries</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">round</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">queries_with_hits</span> <span class="o">/</span> <span class="n">total_queries</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_writer</span> <span class="o">=</span> <span class="n">logging_handlers</span><span class="o">.</span><span class="n">QueueListener</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logging_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_writer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">__print_gff_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locus_out</span><span class="p">,</span> <span class="n">score_keys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private method to print the GFF headers of the output files.</span>
<span class="sd">        Moreover, it will determine whether to start output files for</span>
<span class="sd">        subloci and/or monoloci.</span>
<span class="sd">        Returns: [subloci_metrics_handle, subloci_scores_handle, subloci_handle],</span>
<span class="sd">         monosubloci_outfile</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;##gff-version 3&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">locus_out</span><span class="p">)</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;{0}://&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;db_settings&quot;</span><span class="p">][</span><span class="s2">&quot;dbtype&quot;</span><span class="p">]),</span>
                               <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_connection</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Chrom</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Chrom</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">asc</span><span class="p">()):</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;##sequence-region {0} 1 {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chrom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">chrom</span><span class="o">.</span><span class="n">length</span><span class="p">),</span>
                      <span class="nb">file</span><span class="o">=</span><span class="n">locus_out</span><span class="p">)</span>
                <span class="n">locus_out</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Empty database! Creating a mock one&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;db_settings&quot;</span><span class="p">][</span><span class="s2">&quot;dbtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sqlite&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;db_settings&quot;</span><span class="p">][</span><span class="s2">&quot;db&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">()</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;{0}://&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;db_settings&quot;</span><span class="p">][</span><span class="s2">&quot;dbtype&quot;</span><span class="p">]),</span>
                                   <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_connection</span><span class="p">)</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)()</span>
            <span class="n">dbutils</span><span class="o">.</span><span class="n">DBBASE</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_out</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_out</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="n">sub_metrics_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="s2">&quot;.metrics.tsv&quot;</span><span class="p">,</span>
                                    <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.gff.?$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_out</span><span class="p">)),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">sub_scores_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="s2">&quot;.scores.tsv&quot;</span><span class="p">,</span>
                                   <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.gff.?$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_out</span><span class="p">)),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">sub_metrics</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span>
                <span class="n">sub_metrics_file</span><span class="p">,</span>
                <span class="n">Superlocus</span><span class="o">.</span><span class="n">available_metrics</span><span class="p">,</span>
                <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sub_metrics</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
            <span class="n">sub_scores</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span>
                <span class="n">sub_scores_file</span><span class="p">,</span> <span class="n">score_keys</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sub_scores</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
            <span class="c1"># Not a very clean wya to do things ... attaching the handles as properties</span>
            <span class="n">sub_scores</span><span class="o">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">sub_scores_file</span>
            <span class="n">sub_scores</span><span class="o">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">sub_scores</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">flush</span>
            <span class="n">sub_scores</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">sub_scores</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">sub_scores</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">close</span>
            <span class="n">sub_scores</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">sub_scores</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span>
            <span class="n">sub_metrics</span><span class="o">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">sub_metrics_file</span>
            <span class="n">sub_metrics</span><span class="o">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">sub_metrics</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">flush</span>
            <span class="n">sub_metrics</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">sub_metrics</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">sub_metrics</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">close</span>
            <span class="n">sub_metrics</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">sub_metrics</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span>
            <span class="n">sub_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sub_out</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;##gff-version 3&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sub_out</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Chrom</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Chrom</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">desc</span><span class="p">()):</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;##sequence-region {0} 1 {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chrom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">chrom</span><span class="o">.</span><span class="n">length</span><span class="p">),</span>
                      <span class="nb">file</span><span class="o">=</span><span class="n">sub_out</span><span class="p">)</span>
            <span class="n">sub_out</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">sub_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">sub_metrics</span><span class="p">,</span>
                         <span class="n">sub_scores</span><span class="p">,</span>
                         <span class="n">sub_out</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sub_files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monolocus_out</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">mono_metrics_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="s2">&quot;.metrics.tsv&quot;</span><span class="p">,</span>
                                     <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.gff.?$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">monolocus_out</span><span class="p">)),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">mono_scores_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="s2">&quot;.scores.tsv&quot;</span><span class="p">,</span>
                                    <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;.gff.?$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">monolocus_out</span><span class="p">)),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>          
            <span class="n">mono_metrics</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span>
                <span class="n">mono_metrics_file</span><span class="p">,</span>
                <span class="n">Superlocus</span><span class="o">.</span><span class="n">available_metrics</span><span class="p">,</span>
                <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">mono_metrics</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
            <span class="n">mono_scores</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span>
                <span class="n">mono_scores_file</span><span class="p">,</span> <span class="n">score_keys</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">mono_scores</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
            <span class="c1"># Not a very clean wya to do things ... attaching the handles as properties</span>
            <span class="n">mono_scores</span><span class="o">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">mono_scores_file</span>
            <span class="n">mono_scores</span><span class="o">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">mono_scores</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">flush</span>
            <span class="n">mono_scores</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">mono_scores</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">mono_scores</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">close</span>
            <span class="n">mono_scores</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">mono_scores</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span>
            <span class="n">mono_metrics</span><span class="o">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">mono_metrics_file</span>
            <span class="n">mono_metrics</span><span class="o">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">mono_metrics</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">flush</span>
            <span class="n">mono_metrics</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">mono_metrics</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">mono_metrics</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">close</span>
            <span class="n">mono_metrics</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">mono_metrics</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span>
            <span class="n">mono_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monolocus_out</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;##gff-version 3&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">mono_out</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Chrom</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Chrom</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">desc</span><span class="p">()):</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;##sequence-region {0} 1 {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chrom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">chrom</span><span class="o">.</span><span class="n">length</span><span class="p">),</span>
                      <span class="nb">file</span><span class="o">=</span><span class="n">mono_out</span><span class="p">)</span>

            <span class="n">mono_out</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">mono_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">mono_metrics</span><span class="p">,</span>
                          <span class="n">mono_scores</span><span class="p">,</span>
                          <span class="n">mono_out</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mono_files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>

        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sub_files</span><span class="p">,</span> <span class="n">mono_files</span>

    <span class="k">def</span> <span class="nf">__get_output_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method used by printer to prepare all the output files.</span>
<span class="sd">        :return: ((locus_metrics, locus_scores, locus_out),</span>
<span class="sd">                (sub_metrics, sub_scores, sub_out),</span>
<span class="sd">                mono_out)</span>
<span class="sd">                all of these are file handles</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">score_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tid&quot;</span><span class="p">,</span> <span class="s2">&quot;parent&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regressor</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">score_keys</span> <span class="o">+=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;scoring&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score_keys</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regressor</span><span class="o">.</span><span class="n">metrics</span>
        <span class="c1"># Define mandatory output files</span>
        <span class="n">locus_metrics_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="s2">&quot;.metrics.tsv&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
            <span class="s2">&quot;.gff.?$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">locus_out</span><span class="p">)),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">locus_scores_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="s2">&quot;.scores.tsv&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
            <span class="s2">&quot;.gff.?$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">locus_out</span><span class="p">)),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">locus_metrics</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span>
            <span class="n">locus_metrics_file</span><span class="p">,</span>
            <span class="n">Superlocus</span><span class="o">.</span><span class="n">available_metrics</span><span class="p">,</span>
            <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">locus_metrics</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
        <span class="n">locus_scores</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">locus_scores_file</span><span class="p">,</span> <span class="n">score_keys</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">locus_scores</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>

        <span class="n">locus_metrics</span><span class="o">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">locus_metrics_file</span>
        <span class="n">locus_metrics</span><span class="o">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">locus_metrics</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">flush</span>
        <span class="n">locus_metrics</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">locus_metrics</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">close</span>
        <span class="n">locus_metrics</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">locus_metrics</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span>
        <span class="n">locus_scores</span><span class="o">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">locus_scores_file</span>
        <span class="n">locus_scores</span><span class="o">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">locus_scores</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">flush</span>
        <span class="n">locus_scores</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">locus_scores</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">close</span>
        <span class="n">locus_scores</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">locus_scores</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">name</span>

        <span class="n">locus_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locus_out</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">sub_files</span><span class="p">,</span> <span class="n">mono_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__print_gff_headers</span><span class="p">(</span><span class="n">locus_out</span><span class="p">,</span> <span class="n">score_keys</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">((</span><span class="n">locus_metrics</span><span class="p">,</span>
                 <span class="n">locus_scores</span><span class="p">,</span>
                 <span class="n">locus_out</span><span class="p">),</span>
                <span class="n">sub_files</span><span class="p">,</span> <span class="n">mono_files</span><span class="p">)</span>

    <span class="c1"># This method has many local variables, but most (9!) are</span>
    <span class="c1"># actually file handlers. I cannot trim them down for now.</span>
    <span class="c1"># pylint: disable=too-many-locals</span>

    <span class="k">def</span> <span class="nf">_print_locus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stranded_locus</span><span class="p">,</span> <span class="n">gene_counter</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">handles</span><span class="o">=</span><span class="p">()):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method that handles a single superlocus for printing.</span>
<span class="sd">        It also detects and flags/discard fragmentary loci.</span>
<span class="sd">        :param stranded_locus: the stranded locus to analyse</span>
<span class="sd">        :param gene_counter: A counter used to rename the genes/transcripts progressively</span>
<span class="sd">        :param logger: logger instance</span>
<span class="sd">        :param handles: the handles to print to</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">locus_metrics</span><span class="p">,</span> <span class="n">locus_scores</span><span class="p">,</span> <span class="n">locus_out</span> <span class="o">=</span> <span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sub_metrics</span><span class="p">,</span> <span class="n">sub_scores</span><span class="p">,</span> <span class="n">sub_out</span> <span class="o">=</span> <span class="n">handles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mono_metrics</span><span class="p">,</span> <span class="n">mono_scores</span><span class="p">,</span> <span class="n">mono_out</span> <span class="o">=</span> <span class="n">handles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">stranded_locus</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_out</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># Skip this section if no sub_out is defined</span>
            <span class="n">sub_lines</span> <span class="o">=</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">__str__</span><span class="p">(</span>
                <span class="n">level</span><span class="o">=</span><span class="s2">&quot;subloci&quot;</span><span class="p">,</span>
                <span class="n">print_cds</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;exclude_cds&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">sub_lines</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">sub_lines</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sub_out</span><span class="p">)</span>
                <span class="c1"># sub_out.flush()</span>
            <span class="n">sub_metrics_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">print_subloci_metrics</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="p">{}</span> <span class="ow">and</span> <span class="s2">&quot;tid&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
            <span class="n">sub_scores_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">print_subloci_scores</span><span class="p">()</span>
                               <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="p">{}</span> <span class="ow">and</span> <span class="s2">&quot;tid&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sub_metrics_rows</span><span class="p">:</span>
                <span class="n">sub_metrics</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="c1"># sub_metrics.flush()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sub_scores_rows</span><span class="p">:</span>
                <span class="n">sub_scores</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="c1"># sub_scores.flush()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monolocus_out</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">mono_lines</span> <span class="o">=</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">__str__</span><span class="p">(</span>
                <span class="n">level</span><span class="o">=</span><span class="s2">&quot;monosubloci&quot;</span><span class="p">,</span>
                <span class="n">print_cds</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;exclude_cds&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">mono_lines</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">mono_lines</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">mono_out</span><span class="p">)</span>
                <span class="c1"># mono_out.flush()</span>
            <span class="n">mono_metrics_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">print_subloci_metrics</span><span class="p">()</span>
                                 <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="p">{}</span> <span class="ow">and</span> <span class="s2">&quot;tid&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
            <span class="n">mono_scores_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">print_subloci_scores</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="p">{}</span> <span class="ow">and</span> <span class="s2">&quot;tid&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">mono_metrics_rows</span><span class="p">:</span>
                <span class="n">mono_metrics</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="c1"># mono_metrics.flush()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">mono_scores_rows</span><span class="p">:</span>
                <span class="n">mono_scores</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="c1"># mono_scores.flush()</span>
                
        <span class="k">for</span> <span class="n">locus</span> <span class="ow">in</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">loci</span><span class="p">:</span>
            <span class="n">gene_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">fragment_test</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;remove_overlapping_fragments&quot;</span><span class="p">]</span>
                <span class="ow">is</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">loci</span><span class="p">[</span><span class="n">locus</span><span class="p">]</span><span class="o">.</span><span class="n">is_fragment</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fragment_test</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">new_id</span> <span class="o">=</span> <span class="s2">&quot;{0}.{1}G{2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;output_format&quot;</span><span class="p">][</span><span class="s2">&quot;id_prefix&quot;</span><span class="p">],</span>
                <span class="n">stranded_locus</span><span class="o">.</span><span class="n">chrom</span><span class="p">,</span> <span class="n">gene_counter</span><span class="p">)</span>
            <span class="n">stranded_locus</span><span class="o">.</span><span class="n">loci</span><span class="p">[</span><span class="n">locus</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">new_id</span>

        <span class="n">locus_lines</span> <span class="o">=</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">__str__</span><span class="p">(</span>
            <span class="n">print_cds</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;exclude_cds&quot;</span><span class="p">],</span>
            <span class="n">level</span><span class="o">=</span><span class="s2">&quot;loci&quot;</span><span class="p">)</span>
        <span class="n">locus_metrics_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">print_loci_metrics</span><span class="p">()]</span>
        <span class="n">locus_scores_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">print_loci_scores</span><span class="p">()]</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">locus_metrics_rows</span><span class="p">:</span>
            <span class="n">locus_metrics</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="c1"># locus_metrics.flush()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">locus_scores_rows</span><span class="p">:</span>
            <span class="n">locus_scores</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="c1"># locus_scores.flush()</span>

        <span class="k">if</span> <span class="n">locus_lines</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">locus_lines</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">locus_out</span><span class="p">)</span>
            <span class="c1"># locus_out.flush()</span>
        <span class="k">return</span> <span class="n">gene_counter</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">not_pickable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_pickable</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">not_pickable</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">state</span><span class="p">[</span><span class="n">not_pickable</span><span class="p">]</span>

        <span class="k">print</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="c1"># pylint: disable=too-many-locals</span>
    <span class="k">def</span> <span class="nf">__preload_blast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">queries</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Private method to load all the blast information</span>
<span class="sd">        into a specific dictionary.</span>

<span class="sd">        :param engine: the connection engine from the preloading thread</span>
<span class="sd">        :param queries: a dictionary containing the name=&gt;ID relationship</span>
<span class="sd">         for queries</span>
<span class="sd">        :returns hits_dict: a dictionary with the loaded BLAST data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">hits_dict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">hsps</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">hsp</span> <span class="ow">in</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from hsp where hsp_evalue &lt;= {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;chimera_split&quot;</span><span class="p">][</span><span class="s2">&quot;blast_params&quot;</span><span class="p">][</span><span class="s2">&quot;hsp_evalue&quot;</span><span class="p">]</span>
        <span class="p">)):</span>
            <span class="k">if</span> <span class="n">hsp</span><span class="o">.</span><span class="n">query_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hsps</span><span class="p">:</span>
                <span class="n">hsps</span><span class="p">[</span><span class="n">hsp</span><span class="o">.</span><span class="n">query_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="n">hsps</span><span class="p">[</span><span class="n">hsp</span><span class="o">.</span><span class="n">query_id</span><span class="p">][</span><span class="n">hsp</span><span class="o">.</span><span class="n">target_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hsp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;{0} HSPs prepared&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hsps</span><span class="p">)))</span>

        <span class="n">targets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">target_id</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from target&quot;</span><span class="p">))</span>

        <span class="n">hit_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;select * from hit where evalue &lt;= {0} and hit_number &lt;= {1}&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;order by query_id, evalue asc;&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;chimera_split&quot;</span><span class="p">][</span><span class="s2">&quot;blast_params&quot;</span><span class="p">][</span><span class="s2">&quot;evalue&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;chimera_split&quot;</span><span class="p">][</span><span class="s2">&quot;blast_params&quot;</span><span class="p">][</span><span class="s2">&quot;max_target_seqs&quot;</span><span class="p">]))</span>

        <span class="c1"># self.main_logger.info(&quot;{0} BLAST hits to analyse&quot;.format(hits))</span>
        <span class="n">current_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_hit</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">previous_evalue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">max_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;chimera_split&quot;</span><span class="p">][</span><span class="s2">&quot;blast_params&quot;</span><span class="p">][</span><span class="s2">&quot;max_target_seqs&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current_hit</span> <span class="o">!=</span> <span class="n">hit</span><span class="o">.</span><span class="n">query_id</span><span class="p">:</span>
                <span class="n">current_hit</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="n">query_id</span>
                <span class="n">current_counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">previous_evalue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">if</span> <span class="n">current_counter</span> <span class="o">&gt;</span> <span class="n">max_targets</span> <span class="ow">and</span> <span class="n">previous_evalue</span> <span class="o">&lt;</span> <span class="n">hit</span><span class="o">.</span><span class="n">evalue</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">previous_evalue</span> <span class="o">&lt;</span> <span class="n">hit</span><span class="o">.</span><span class="n">evalue</span><span class="p">:</span>
                <span class="n">previous_evalue</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="n">evalue</span>

            <span class="n">current_counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">my_query</span> <span class="o">=</span> <span class="n">queries</span><span class="p">[</span><span class="n">hit</span><span class="o">.</span><span class="n">query_id</span><span class="p">]</span>
            <span class="n">my_target</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">hit</span><span class="o">.</span><span class="n">target_id</span><span class="p">]</span>

            <span class="c1"># We HAVE to use the += approach because extend/append</span>
            <span class="c1"># leaves the original list empty</span>
            <span class="n">hits_dict</span><span class="p">[</span><span class="n">my_query</span><span class="o">.</span><span class="n">query_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Hit</span><span class="o">.</span><span class="n">as_full_dict_static</span><span class="p">(</span>
                    <span class="n">hit</span><span class="p">,</span>
                    <span class="n">hsps</span><span class="p">[</span><span class="n">hit</span><span class="o">.</span><span class="n">query_id</span><span class="p">][</span><span class="n">hit</span><span class="o">.</span><span class="n">target_id</span><span class="p">],</span>
                    <span class="n">my_query</span><span class="p">,</span>
                    <span class="n">my_target</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">hit_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">hit_counter</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">4</span> <span class="ow">and</span> <span class="n">hit_counter</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loaded </span><span class="si">%d</span><span class="s2"> BLAST hits in database&quot;</span><span class="p">,</span>
                                       <span class="n">hit_counter</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">hsps</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">hits_dict</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> BLAST hits loaded for </span><span class="si">%d</span><span class="s2"> queries&quot;</span><span class="p">,</span>
                              <span class="n">hit_counter</span><span class="p">,</span>
                              <span class="nb">len</span><span class="p">(</span><span class="n">hits_dict</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                   <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">hits_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[:</span><span class="mi">10</span><span class="p">]]))</span>
        <span class="k">return</span> <span class="n">hits_dict</span>
    <span class="c1"># pylint: enable=too-many-locals</span>

<div class="viewcode-block" id="Picker.preload"><a class="viewcode-back" href="../../../Mikado.picking.html#Mikado.picking.picker.Picker.preload">[docs]</a>    <span class="k">def</span> <span class="nf">preload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method preloads the data from the DB into a dictionary (&quot;data_dict&quot;).</span>
<span class="sd">        The information on what to extract and how to connect to the</span>
<span class="sd">        DB is retrieved from the json_conf dictionary.</span>
<span class="sd">        :return: data_dict</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting to preload the database into memory&quot;</span><span class="p">)</span>

        <span class="c1"># data_dict = self.manager.dict(lock=False)</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;{0}://&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;db_settings&quot;</span><span class="p">][</span><span class="s2">&quot;dbtype&quot;</span><span class="p">]),</span>
                               <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_connection</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)()</span>

        <span class="n">junc_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">junc</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Junction</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">junc</span><span class="o">.</span><span class="n">chrom</span><span class="p">,</span> <span class="n">junc</span><span class="o">.</span><span class="n">junction_start</span><span class="p">,</span> <span class="n">junc</span><span class="o">.</span><span class="n">junction_end</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">junc_dict</span>
            <span class="n">junc_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">junc</span><span class="o">.</span><span class="n">strand</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;junctions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">junc_dict</span>

        <span class="c1"># data_dict[&quot;junctions&quot;] = self.manager.dict(data_dict[&quot;junctions&quot;], lock=False)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> junctions loaded&quot;</span><span class="p">,</span>
                              <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;junctions&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Example junctions:</span><span class="se">\n</span><span class="s2">{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">junc</span><span class="p">)</span> <span class="k">for</span> <span class="n">junc</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;junctions&quot;</span><span class="p">])[:</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;junctions&quot;</span><span class="p">]))])))</span>

        <span class="n">queries</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">que</span><span class="o">.</span><span class="n">query_id</span><span class="p">,</span> <span class="n">que</span><span class="p">)</span> <span class="k">for</span> <span class="n">que</span> <span class="ow">in</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from query&quot;</span><span class="p">))</span>

        <span class="c1"># Then load ORFs</span>
        <span class="n">orf_dict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">orf</span> <span class="ow">in</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from orf&quot;</span><span class="p">):</span>

            <span class="n">query_name</span> <span class="o">=</span> <span class="n">queries</span><span class="p">[</span><span class="n">orf</span><span class="o">.</span><span class="n">query_id</span><span class="p">]</span><span class="o">.</span><span class="n">query_name</span>
            <span class="n">orf_dict</span><span class="p">[</span><span class="n">query_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Orf</span><span class="o">.</span><span class="n">as_bed12_static</span><span class="p">(</span><span class="n">orf</span><span class="p">,</span> <span class="n">query_name</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;orfs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orf_dict</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;orfs&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;select count(distinct(query_id)) from orf&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># data_dict[&#39;orf&#39;] = self.manager.dict(orfs, lock=False)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> ORFs loaded&quot;</span><span class="p">,</span>
                              <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;orfs&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;orfs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="p">))</span>

        <span class="c1"># Finally load BLAST</span>

        <span class="c1"># if self.json_conf[&quot;pick&quot;][&quot;chimera_split&quot;][&quot;execute&quot;] is True and \</span>
        <span class="c1">#         self.json_conf[&quot;pick&quot;][&quot;chimera_split&quot;][&quot;blast_check&quot;] is True:</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;hits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__preload_blast</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">queries</span><span class="p">)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     data_dict[&quot;hits&quot;] = dict()</span>
        <span class="c1">#     self.main_logger.info(&quot;Skipping BLAST loading&quot;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished to preload the database into memory&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data_dict</span></div>

    <span class="k">def</span> <span class="nf">_submit_locus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slocus</span><span class="p">,</span> <span class="n">counter</span><span class="p">,</span> <span class="n">data_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method to submit / start the analysis of a superlocus in input.</span>
<span class="sd">        :param slocus: the locus to analyse.</span>
<span class="sd">        :param data_dict: the preloaded data in memory</span>
<span class="sd">        :param engine: connection engine</span>
<span class="sd">        :return: job object / None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">slocus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Submitting </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">slocus</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading data for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">slocus</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">slocus</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>
        <span class="n">slocus</span><span class="o">.</span><span class="n">load_all_transcript_data</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
                                        <span class="n">data_dict</span><span class="o">=</span><span class="n">data_dict</span><span class="p">)</span>
        <span class="c1"># slocus_id = slocus.id</span>
        <span class="k">if</span> <span class="n">slocus</span><span class="o">.</span><span class="n">initialized</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="c1"># This happens when we have removed all transcripts from the locus</span>
            <span class="c1"># due to errors which should have been caught and logged</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> had all transcripts failing checks, ignoring it&quot;</span><span class="p">,</span>
                <span class="n">slocus</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="c1"># Exit</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">analyse_locus</span><span class="p">(</span><span class="n">slocus</span><span class="o">=</span><span class="n">slocus</span><span class="p">,</span>
                             <span class="n">counter</span><span class="o">=</span><span class="n">counter</span><span class="p">,</span>
                             <span class="n">json_conf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">,</span>
                             <span class="n">printer_queue</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                             <span class="n">logging_queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_queue</span><span class="p">,</span>
                             <span class="n">data_dict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                             <span class="n">engine</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unsorted_interrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">current_transcript</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method that brings the program to a screeching halt</span>
<span class="sd">         if the GTF/GFF is not properly sorted.</span>
<span class="sd">        :param row:</span>
<span class="sd">        :param current_transcript:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># self.result_dict[counter] = [_]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printer_queue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">((</span><span class="s2">&quot;EXIT&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)))</span>
        <span class="c1"># self.printer_queue.put((&quot;EXIT&quot;, counter + 1))</span>
        <span class="n">current</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">chrom</span><span class="p">,</span>
                                              <span class="n">row</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                              <span class="n">row</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
                                              <span class="n">row</span><span class="o">.</span><span class="n">strand</span><span class="p">]])</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">current_transcript</span><span class="o">.</span><span class="n">chrom</span><span class="p">,</span>
                                               <span class="n">current_transcript</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                               <span class="n">current_transcript</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
                                               <span class="n">current_transcript</span><span class="o">.</span><span class="n">strand</span><span class="p">]])</span>

        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Unsorted input file, the results will not be correct.</span>
<span class="s2">            Please provide a properly sorted input. Error:</span>
<span class="s2">            {0}</span>
<span class="s2">            {1}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current</span><span class="p">,</span>
                          <span class="n">previous</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;CRITICAL - {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)]))</span>
        <span class="k">raise</span> <span class="n">UnsortedInput</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__test_sortedness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">current_transcript</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method to test whether a row and the current transcript are actually in the expected</span>
<span class="sd">        sorted order.</span>
<span class="sd">        :param row:</span>
<span class="sd">        :param current_transcript:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">current_transcript</span><span class="o">.</span><span class="n">chrom</span> <span class="o">&gt;</span> <span class="n">row</span><span class="o">.</span><span class="n">chrom</span><span class="p">:</span>
            <span class="n">test</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">current_transcript</span><span class="o">.</span><span class="n">chrom</span> <span class="o">==</span> <span class="n">row</span><span class="o">.</span><span class="n">chrom</span> <span class="ow">and</span>
              <span class="n">current_transcript</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">row</span><span class="o">.</span><span class="n">start</span><span class="p">):</span>
            <span class="n">test</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">current_transcript</span><span class="o">.</span><span class="n">chrom</span> <span class="o">==</span> <span class="n">row</span><span class="o">.</span><span class="n">chrom</span> <span class="ow">and</span>
              <span class="n">current_transcript</span><span class="o">.</span><span class="n">start</span> <span class="o">==</span> <span class="n">row</span><span class="o">.</span><span class="n">start</span> <span class="ow">and</span>
              <span class="n">current_transcript</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">row</span><span class="o">.</span><span class="n">end</span><span class="p">):</span>
            <span class="n">test</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__unsorted_interrupt</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">current_transcript</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__submit_multi_threading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to execute Mikado.py pick in multi threaded mode.</span>

<span class="sd">        :param data_dict: The data dictionary</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">intron_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;intron_range&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Intron range: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">intron_range</span><span class="p">)</span>

        <span class="n">current_locus</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">current_transcript</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">locus_queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">handles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__get_output_files</span><span class="p">())</span>
        <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">handles</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">handles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">handles</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
            <span class="n">handles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

        <span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                                              <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;mikado_pick_tmp&quot;</span><span class="p">,</span>
                                              <span class="nb">dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="s2">&quot;output_dir&quot;</span><span class="p">])</span>

        <span class="n">working_processes</span> <span class="o">=</span> <span class="p">[</span><span class="n">LociProcesser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">,</span>
                                           <span class="n">data_dict</span><span class="p">,</span>
                                           <span class="n">handles</span><span class="p">,</span>
                                           <span class="n">locus_queue</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">logging_queue</span><span class="p">,</span>
                                           <span class="n">_</span><span class="p">,</span>
                                           <span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="c1"># Start all processes</span>
        <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">working_processes</span><span class="p">]</span>
        <span class="c1"># No sense in keeping this data available on the main thread now</span>
        <span class="k">del</span> <span class="n">data_dict</span>

        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">invalid</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_input</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">is_exon</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">invalid</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">current_transcript</span><span class="o">.</span><span class="n">add_exon</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">InvalidTranscript</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Transcript </span><span class="si">%s</span><span class="s2"> is invalid;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                      <span class="n">current_transcript</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                      <span class="n">exc</span><span class="p">)</span>
                    <span class="n">invalid</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">row</span><span class="o">.</span><span class="n">is_transcript</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_transcript</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">invalid</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__test_sortedness</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">current_transcript</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">Superlocus</span><span class="o">.</span><span class="n">in_locus</span><span class="p">(</span>
                            <span class="n">current_locus</span><span class="p">,</span> <span class="n">current_transcript</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                        <span class="n">current_locus</span><span class="o">.</span><span class="n">add_transcript_to_locus</span><span class="p">(</span><span class="n">current_transcript</span><span class="p">,</span>
                                                              <span class="n">check_in_locus</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Submitting locus # </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
                        <span class="n">locus_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">current_locus</span><span class="p">,</span> <span class="n">counter</span><span class="p">))</span>
                        <span class="n">current_locus</span> <span class="o">=</span> <span class="n">Superlocus</span><span class="p">(</span>
                            <span class="n">current_transcript</span><span class="p">,</span>
                            <span class="n">stranded</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                            <span class="n">json_conf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">,</span>
                            <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;output_format&quot;</span><span class="p">][</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">current_transcript</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">row</span><span class="o">.</span><span class="n">chrom</span> <span class="o">!=</span> <span class="n">current_transcript</span><span class="o">.</span><span class="n">chrom</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">current_transcript</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished chromosome </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                         <span class="n">current_transcript</span><span class="o">.</span><span class="n">chrom</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting chromosome </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">chrom</span><span class="p">)</span>

                <span class="n">invalid</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">current_transcript</span> <span class="o">=</span> <span class="n">Transcript</span><span class="p">(</span>
                    <span class="n">row</span><span class="p">,</span>
                    <span class="n">intron_range</span><span class="o">=</span><span class="n">intron_range</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">current_transcript</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">invalid</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Superlocus</span><span class="o">.</span><span class="n">in_locus</span><span class="p">(</span>
                    <span class="n">current_locus</span><span class="p">,</span> <span class="n">current_transcript</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">current_locus</span><span class="o">.</span><span class="n">add_transcript_to_locus</span><span class="p">(</span>
                    <span class="n">current_transcript</span><span class="p">,</span> <span class="n">check_in_locus</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Submitting locus # </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
                <span class="n">locus_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">current_locus</span><span class="p">,</span> <span class="n">counter</span><span class="p">))</span>

                <span class="n">current_locus</span> <span class="o">=</span> <span class="n">Superlocus</span><span class="p">(</span>
                    <span class="n">current_transcript</span><span class="p">,</span>
                    <span class="n">stranded</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">json_conf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">,</span>
                    <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;output_format&quot;</span><span class="p">][</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created last locus </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                  <span class="n">current_locus</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">invalid</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">current_locus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Submitting locus # </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
            <span class="n">locus_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">current_locus</span><span class="p">,</span> <span class="n">counter</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished chromosome </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">current_locus</span><span class="o">.</span><span class="n">chrom</span><span class="p">)</span>

        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">locus_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">current_locus</span><span class="p">,</span> <span class="n">counter</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Submitting locus </span><span class="si">%s</span><span class="s2">, counter </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="n">current_locus</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
        <span class="n">locus_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s2">&quot;EXIT&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Joining children processes&quot;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">join</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">working_processes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Joined children processes; starting to merge partial files&quot;</span><span class="p">)</span>

        <span class="c1"># Merge loci</span>
        <span class="n">merge_loci</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">,</span>
                   <span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                   <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;output_format&quot;</span><span class="p">][</span><span class="s2">&quot;id_prefix&quot;</span><span class="p">],</span>
                   <span class="n">tempdir</span><span class="o">=</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">handle</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
                    <span class="n">partials</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                             <span class="s2">&quot;{0}-{1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">handle</span><span class="p">),</span> <span class="n">_</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">procs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
                    <span class="n">merge_partial</span><span class="p">(</span><span class="n">partials</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
                    <span class="c1"># [os.remove(_) for _ in partials]</span>

        <span class="k">for</span> <span class="n">handle</span> <span class="ow">in</span> <span class="n">handles</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
                    <span class="n">partials</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                             <span class="s2">&quot;{0}-{1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">handle</span><span class="p">),</span> <span class="n">_</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">procs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
                    <span class="n">merge_partial</span><span class="p">(</span><span class="n">partials</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
                    <span class="c1"># [os.remove(_) for _ in partials]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished merging partial files&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tempdir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">FileNotFoundError</span><span class="p">,</span> <span class="n">FileExistsError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to clean up the temporary directory </span><span class="si">%s</span><span class="s2">, error: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to clean up the temporary directory </span><span class="si">%s</span><span class="s2">, error: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">__submit_single_threaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to execute Mikado.py pick in single threaded mode.</span>
<span class="sd">        :param data_dict:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">current_locus</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">current_transcript</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging_handlers</span><span class="o">.</span><span class="n">QueueHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_queue</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;queue_listener&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;log_settings&quot;</span><span class="p">][</span><span class="s2">&quot;log_level&quot;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Begun single-threaded run&quot;</span><span class="p">)</span>

        <span class="n">intron_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;intron_range&quot;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Intron range: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">intron_range</span><span class="p">)</span>

        <span class="n">handles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_output_files</span><span class="p">()</span>

        <span class="n">locus_printer</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_print_locus</span><span class="p">,</span>
                                          <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
                                          <span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">)</span>

        <span class="c1"># last_printed = -1</span>
        <span class="n">curr_chrom</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">gene_counter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;preload&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="c1"># db_connection = functools.partial(dbutils.create_connector,</span>
            <span class="c1">#                                   self.json_conf,</span>
            <span class="c1">#                                   self.logger)</span>
            <span class="c1"># self.connection_pool = sqlalchemy.pool.QueuePool(db_connection,</span>
            <span class="c1">#                                                  pool_size=1,</span>
            <span class="c1">#                                                  max_overflow=2)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">dbutils</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">json_conf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">submit_locus</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_submit_locus</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;data_dict&quot;</span><span class="p">:</span> <span class="n">data_dict</span><span class="p">,</span>
                                                                <span class="s2">&quot;engine&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">})</span>

        <span class="n">counter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">invalid</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_input</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">is_exon</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">invalid</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">current_transcript</span><span class="o">.</span><span class="n">add_exon</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">InvalidTranscript</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Transcript </span><span class="si">%s</span><span class="s2"> is invalid;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                      <span class="n">current_transcript</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                      <span class="n">exc</span><span class="p">)</span>
                    <span class="n">invalid</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">row</span><span class="o">.</span><span class="n">is_transcript</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_transcript</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">invalid</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__test_sortedness</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">current_transcript</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">Superlocus</span><span class="o">.</span><span class="n">in_locus</span><span class="p">(</span>
                            <span class="n">current_locus</span><span class="p">,</span> <span class="n">current_transcript</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                        <span class="n">current_locus</span><span class="o">.</span><span class="n">add_transcript_to_locus</span><span class="p">(</span><span class="n">current_transcript</span><span class="p">,</span>
                                                              <span class="n">check_in_locus</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Analysing locus # </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">stranded_locus</span> <span class="ow">in</span> <span class="n">submit_locus</span><span class="p">(</span><span class="n">current_locus</span><span class="p">,</span> <span class="n">counter</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">chrom</span> <span class="o">!=</span> <span class="n">curr_chrom</span><span class="p">:</span>
                                    <span class="n">curr_chrom</span> <span class="o">=</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">chrom</span>
                                    <span class="n">gene_counter</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">gene_counter</span> <span class="o">=</span> <span class="n">locus_printer</span><span class="p">(</span><span class="n">stranded_locus</span><span class="p">,</span> <span class="n">gene_counter</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                            <span class="k">raise</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                                <span class="s2">&quot;Superlocus </span><span class="si">%s</span><span class="s2"> failed with exception: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="bp">None</span> <span class="k">if</span> <span class="n">current_locus</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">current_locus</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>

                        <span class="n">current_locus</span> <span class="o">=</span> <span class="n">Superlocus</span><span class="p">(</span>
                            <span class="n">current_transcript</span><span class="p">,</span>
                            <span class="n">stranded</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                            <span class="n">json_conf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">,</span>
                            <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;output_format&quot;</span><span class="p">][</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regressor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">current_locus</span><span class="o">.</span><span class="n">regressor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regressor</span>

                <span class="k">if</span> <span class="n">current_transcript</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">row</span><span class="o">.</span><span class="n">chrom</span> <span class="o">!=</span> <span class="n">current_transcript</span><span class="o">.</span><span class="n">chrom</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">current_transcript</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished chromosome </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                         <span class="n">current_transcript</span><span class="o">.</span><span class="n">chrom</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting chromosome </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">chrom</span><span class="p">)</span>

                <span class="n">invalid</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">current_transcript</span> <span class="o">=</span> <span class="n">Transcript</span><span class="p">(</span>
                    <span class="n">row</span><span class="p">,</span>
                    <span class="n">intron_range</span><span class="o">=</span><span class="n">intron_range</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">current_transcript</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">invalid</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Superlocus</span><span class="o">.</span><span class="n">in_locus</span><span class="p">(</span>
                    <span class="n">current_locus</span><span class="p">,</span> <span class="n">current_transcript</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">current_locus</span><span class="o">.</span><span class="n">add_transcript_to_locus</span><span class="p">(</span>
                    <span class="n">current_transcript</span><span class="p">,</span> <span class="n">check_in_locus</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Analysing locus # </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">stranded_locus</span> <span class="ow">in</span> <span class="n">submit_locus</span><span class="p">(</span><span class="n">current_locus</span><span class="p">,</span> <span class="n">counter</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">chrom</span> <span class="o">!=</span> <span class="n">curr_chrom</span><span class="p">:</span>
                        <span class="n">curr_chrom</span> <span class="o">=</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">chrom</span>
                        <span class="n">gene_counter</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">gene_counter</span> <span class="o">=</span> <span class="n">locus_printer</span><span class="p">(</span><span class="n">stranded_locus</span><span class="p">,</span> <span class="n">gene_counter</span><span class="p">)</span>

                <span class="n">current_locus</span> <span class="o">=</span> <span class="n">Superlocus</span><span class="p">(</span>
                    <span class="n">current_transcript</span><span class="p">,</span>
                    <span class="n">stranded</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">json_conf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">,</span>
                    <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;output_format&quot;</span><span class="p">][</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created last locus </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                  <span class="n">current_locus</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">current_transcript</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">invalid</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current_locus</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Analysing locus # </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">stranded_locus</span> <span class="ow">in</span> <span class="n">submit_locus</span><span class="p">(</span><span class="n">current_locus</span><span class="p">,</span> <span class="n">counter</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">chrom</span> <span class="o">!=</span> <span class="n">curr_chrom</span><span class="p">:</span>
                        <span class="n">curr_chrom</span> <span class="o">=</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">chrom</span>
                        <span class="n">gene_counter</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">gene_counter</span> <span class="o">=</span> <span class="n">locus_printer</span><span class="p">(</span><span class="n">stranded_locus</span><span class="p">,</span> <span class="n">gene_counter</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished chromosome </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">current_locus</span><span class="o">.</span><span class="n">chrom</span><span class="p">)</span>

        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Analysing locus # </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
        <span class="c1"># if current_locus is not None:</span>
        <span class="c1">#     current_locus.load_all_transcript_data(pool=self.connection_pool,</span>
        <span class="c1">#                                            data_dict=data_dict)</span>
        <span class="k">for</span> <span class="n">stranded_locus</span> <span class="ow">in</span> <span class="n">submit_locus</span><span class="p">(</span><span class="n">current_locus</span><span class="p">,</span> <span class="n">counter</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">chrom</span> <span class="o">!=</span> <span class="n">curr_chrom</span><span class="p">:</span>
                <span class="n">curr_chrom</span> <span class="o">=</span> <span class="n">stranded_locus</span><span class="o">.</span><span class="n">chrom</span>
                <span class="n">gene_counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">gene_counter</span> <span class="o">=</span> <span class="n">locus_printer</span><span class="p">(</span><span class="n">stranded_locus</span><span class="p">,</span> <span class="n">gene_counter</span><span class="p">)</span>
        <span class="c1"># submit_locus(current_locus, counter)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Final number of superloci: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_and_submit_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method does the parsing of the input and submission of the loci to the</span>
<span class="sd">        _submit_locus method.</span>
<span class="sd">        :param data_dict: The cached data from the database</span>
<span class="sd">        :return: jobs (the list of all jobs already submitted)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;single_thread&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__submit_multi_threading</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__submit_single_threaded</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This method will activate the class and start the analysis of the input file.&quot;&quot;&quot;</span>

        <span class="c1"># NOTE: Pool, Process and Manager must NOT become instance attributes!</span>
        <span class="c1"># Otherwise it will raise all sorts of mistakes</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;preload&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># Use the preload function to create the data dictionary</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preload</span><span class="p">()</span>
        <span class="c1"># pylint: disable=no-member</span>
        <span class="c1"># pylint: enable=no-member</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Source: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;output_format&quot;</span><span class="p">][</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;db_settings&quot;</span><span class="p">][</span><span class="s2">&quot;dbtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;sqlite&quot;</span> <span class="ow">and</span> <span class="n">data_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue_pool</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">QueuePool</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_connection</span><span class="p">,</span>
                <span class="n">pool_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">procs</span><span class="p">,</span>
                <span class="n">max_overflow</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_and_submit_input</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UnsortedInput</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;The input files were not properly sorted! Please run prepare and retry.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># list(map(job.get() for job in jobs if job is not None))</span>
        <span class="c1"># for job in iter(x for x in jobs if x is not None):</span>
        <span class="c1">#     job.get()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_writer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue_pool</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>

        <span class="c1"># Clean up the DB copied to SHM</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm_shared&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing shared memory DB </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm_db&quot;</span><span class="p">])</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_conf</span><span class="p">[</span><span class="s2">&quot;pick&quot;</span><span class="p">][</span><span class="s2">&quot;run_options&quot;</span><span class="p">][</span><span class="s2">&quot;shm_db&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished analysis of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>
<span class="c1"># pylint: enable=too-many-instance-attributes</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Luca Venturini, Shabhonam Caim.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
  </body>
</html>