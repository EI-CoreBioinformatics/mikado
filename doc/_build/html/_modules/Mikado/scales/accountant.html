<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Mikado.scales.accountant &mdash; Mikado 19 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '19',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Mikado 19 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Mikado.scales.accountant</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This class is used to store all the data calculated by the Assigner class, in order to produce</span>
<span class="sd">the RefMap/Stats files.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">handlers</span> <span class="k">as</span> <span class="n">log_handlers</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">..loci.transcript</span> <span class="kn">import</span> <span class="n">Transcript</span>
<span class="kn">from</span> <span class="nn">.resultstorer</span> <span class="kn">import</span> <span class="n">ResultStorer</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">calc_f1</span>


<span class="c1"># noinspection PyPropertyAccess,PyPropertyAccess,PyPropertyAccess</span>
<span class="c1"># pylint: disable=too-many-instance-attributes</span>
<div class="viewcode-block" id="Accountant"><a class="viewcode-back" href="../../../Mikado.scales.html#Mikado.scales.accountant.Accountant">[docs]</a><span class="k">class</span> <span class="nc">Accountant</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This class stores the data necessary to calculate the final statistics</span>
<span class="sd">     - base and exon Sn/Sp/F1 etc.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Class constructor. It requires:</span>
<span class="sd">        :param genes: a dictionary</span>
<span class="sd">        :type genes: dict</span>
<span class="sd">        :param args: A namespace (like those provided by argparse)</span>
<span class="sd">        containing the parameters for the run.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_handler</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setup_logger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Started with stat printing&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">introns</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exons</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">starts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ends</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intron_chains</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monoexonic_matches</span> <span class="o">=</span> <span class="p">(</span><span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_genes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred_genes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setup_reference_data</span><span class="p">(</span><span class="n">genes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setup_reference_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genes</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method that prepares the reference data into the data structure</span>
<span class="sd">        that will be used to compare each prediction with a reference transcript.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">genes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_genes</span><span class="p">[</span><span class="n">gene</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">transcr</span> <span class="ow">in</span> <span class="n">genes</span><span class="p">[</span><span class="n">gene</span><span class="p">]:</span>
                <span class="c1"># 0b000, indicating:</span>
                <span class="c1"># First bit: stringent match (100% F1)</span>
                <span class="c1"># Second bit: normal match (95% F1)</span>
                <span class="c1"># Third bit: lenient match (80% F1)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_genes</span><span class="p">[</span><span class="n">gene</span><span class="p">][</span><span class="n">transcr</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mb">0b1000</span>
                <span class="c1">#                 self.ref_transcript_num+=1</span>
                <span class="k">if</span> <span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">introns</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">()),</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">()),</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ends</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">()),</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())])</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">introns</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">()),</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">intron_chains</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">()),</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())])</span>
                <span class="k">if</span> <span class="n">transcr</span><span class="o">.</span><span class="n">strand</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">strand</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">strand</span> <span class="o">=</span> <span class="n">transcr</span><span class="o">.</span><span class="n">strand</span>

                <span class="c1"># 0b000001: in reference</span>
                <span class="c1"># 0b000010: in prediction</span>
                <span class="c1"># 0b000100: single</span>
                <span class="c1"># 0b001000: internal</span>
                <span class="c1"># 0b010000: border</span>
                <span class="c1"># 0b100000: single match lenient</span>

                <span class="k">if</span> <span class="n">transcr</span><span class="o">.</span><span class="n">exon_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">exon</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">transcr</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">transcr</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]</span> <span class="o">=</span> <span class="mb">0b00000</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b100</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__store_multiexonic_reference</span><span class="p">(</span><span class="n">transcr</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">__store_multiexonic_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transcr</span><span class="p">,</span> <span class="n">strand</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method to store a multiexonic reference transcript.</span>
<span class="sd">        :param transcr:</span>
<span class="sd">        :param strand:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">intron_chain</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">intron</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">transcr</span><span class="o">.</span><span class="n">introns</span><span class="p">):</span>
            <span class="n">intron</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">intron</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intron</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">intron_chain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intron</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">introns</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">intron</span><span class="p">]</span> <span class="o">=</span> <span class="mb">0b01</span>
        <span class="n">intron_chain</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">intron_chain</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">intron_chain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intron_chains</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intron_chains</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span>
                <span class="n">strand</span><span class="p">][</span><span class="n">intron_chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intron_chains</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span>
            <span class="n">strand</span><span class="p">][</span><span class="n">intron_chain</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">transcr</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">exon</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transcr</span><span class="o">.</span><span class="n">exons</span><span class="p">):</span>
            <span class="n">exon</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">exon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exon</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">exon</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]</span> <span class="o">=</span> <span class="mb">0b00000</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b01</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b010000</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mb">0b01</span>
            <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="n">transcr</span><span class="o">.</span><span class="n">exon_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b010000</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ends</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mb">0b01</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b01000</span>

    <span class="k">def</span> <span class="nf">__setup_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method to set up the logger using indications in the</span>
<span class="sd">        args namespace.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;log_queue&quot;</span><span class="p">):</span>
            <span class="c1"># noinspection PyUnresolvedReferences</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue_handler</span> <span class="o">=</span> <span class="n">log_handlers</span><span class="o">.</span><span class="n">QueueHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">log_queue</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">NullHandler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;stat_logger&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_handler</span><span class="p">)</span>
        <span class="c1"># noinspection PyUnresolvedReferences</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span>

    <span class="c1"># pylint: disable=too-many-locals</span>
    <span class="k">def</span> <span class="nf">__retrieve_gene_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_name</span><span class="o">=</span><span class="s2">&quot;ref&quot;</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This private method recovers from the pred/ref store the statistics regarding the</span>
<span class="sd">        number of genes and transcripts found and missed,</span>
<span class="sd">        both stringently and leniently.</span>
<span class="sd">        The keyword store_name, which must evaluate to either</span>
<span class="sd">        &quot;ref&quot;</span>
<span class="sd">        or</span>
<span class="sd">        &quot;pred&quot;,</span>
<span class="sd">        indicates whether we are intersted in prediction of reference data.</span>
<span class="sd">        :param store_name: str</span>
<span class="sd">        :return: { &quot;stringent&quot;: (transcript_stringent, gene_stringent),</span>
<span class="sd">                   &quot;lenient&quot;: (transcript_lenient, gene_lenient),</span>
<span class="sd">                   &quot;total&quot;: total_transcripts,</span>
<span class="sd">                   &quot;private&quot;: (private_transcripts, private_genes)</span>
<span class="sd">                   }</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">found_transcripts_stringent</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 100% match</span>
        <span class="n">found_transcripts</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 95% match</span>
        <span class="n">found_transcripts_lenient</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 80% match</span>
        <span class="n">found_genes_stringent</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 100% match</span>
        <span class="n">found_genes</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 95% match</span>
        <span class="n">found_genes_lenient</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 80% match</span>
        <span class="n">private_genes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">private_transcripts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_transcripts</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">store_name</span> <span class="o">==</span> <span class="s2">&quot;ref&quot;</span><span class="p">:</span>
            <span class="n">store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_genes</span>
        <span class="k">elif</span> <span class="n">store_name</span> <span class="o">==</span> <span class="s2">&quot;pred&quot;</span><span class="p">:</span>
            <span class="n">store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_genes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid store selected: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">store_name</span><span class="p">))</span>

        <span class="c1"># 0b000, indicating:</span>
        <span class="c1"># First bit: stringent match (100% F1)</span>
        <span class="c1"># Second bit: normal match (95% F1)</span>
        <span class="c1"># Third bit: lenient match (80% F1)</span>
        <span class="c1"># Fourth bit: private</span>

        <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">store</span><span class="p">:</span>
            <span class="n">gene_match</span> <span class="o">=</span> <span class="mb">0b000</span>
            <span class="n">gene_not_found</span> <span class="o">=</span> <span class="mb">0b1</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">store</span><span class="p">[</span><span class="n">gene</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">total_transcripts</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">found_transcripts_lenient</span> <span class="o">+=</span> <span class="p">(</span><span class="mb">0b100</span> <span class="o">&amp;</span> <span class="n">val</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span>
                <span class="n">found_transcripts</span> <span class="o">+=</span> <span class="p">(</span><span class="mb">0b10</span> <span class="o">&amp;</span> <span class="n">val</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
                <span class="n">found_transcripts_stringent</span> <span class="o">+=</span> <span class="mb">0b1</span> <span class="o">&amp;</span> <span class="n">val</span>
                <span class="c1"># Will evaluate to 1 if the transcript has at least one match</span>
                <span class="n">private_transcripts</span> <span class="o">+=</span> <span class="p">(</span><span class="mb">0b1000</span> <span class="o">&amp;</span> <span class="n">val</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span>
                <span class="n">gene_not_found</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mb">0b1000</span> <span class="o">&amp;</span> <span class="n">val</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span>
                <span class="n">gene_match</span> <span class="o">|=</span> <span class="n">val</span>
            <span class="n">found_genes_stringent</span> <span class="o">+=</span> <span class="n">gene_match</span> <span class="o">&amp;</span> <span class="mb">0b1</span>
            <span class="c1"># Shift back by 1</span>
            <span class="n">found_genes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">gene_match</span> <span class="o">&amp;</span> <span class="mb">0b10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
            <span class="c1"># Shift back by 2</span>
            <span class="n">found_genes_lenient</span> <span class="o">+=</span> <span class="p">(</span><span class="n">gene_match</span> <span class="o">&amp;</span> <span class="mb">0b100</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span>
            <span class="n">private_genes</span> <span class="o">+=</span> <span class="n">gene_not_found</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Found </span><span class="si">%s</span><span class="s2"> transcripts:</span>
<span class="s2">        </span><span class="se">\t</span><span class="s2">stringent</span><span class="se">\t</span><span class="si">%s</span><span class="s2"></span>
<span class="s2">        </span><span class="se">\t</span><span class="s2">lenient</span><span class="se">\t</span><span class="si">%s</span><span class="s2"></span>
<span class="s2">        </span><span class="se">\t</span><span class="s2">total</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="n">store_name</span><span class="p">,</span>
                          <span class="n">found_transcripts_stringent</span><span class="p">,</span>
                          <span class="n">found_transcripts_lenient</span><span class="p">,</span>
                          <span class="n">total_transcripts</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;stringent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">found_transcripts_stringent</span><span class="p">,</span> <span class="n">found_genes_stringent</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;standard&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">found_transcripts</span><span class="p">,</span> <span class="n">found_genes</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;lenient&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">found_transcripts_lenient</span><span class="p">,</span> <span class="n">found_genes_lenient</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_transcripts</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;private&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">private_transcripts</span><span class="p">,</span> <span class="n">private_genes</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c1"># pylint: enable=too-many-locals</span>

    <span class="k">def</span> <span class="nf">__calculate_gene_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Private method that calculates the number of found transcripts</span>
<span class="sd">         in the reference and prediction sets. Wrapper around a double</span>
<span class="sd">         call to __retrieve_gene_stats</span>
<span class="sd">         :return: double the result of __retrieve_gene_stats</span>
<span class="sd">         &quot;&quot;&quot;</span>

        <span class="n">ref_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__retrieve_gene_stats</span><span class="p">(</span><span class="n">store_name</span><span class="o">=</span><span class="s2">&quot;ref&quot;</span><span class="p">)</span>

        <span class="n">pred_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__retrieve_gene_stats</span><span class="p">(</span><span class="n">store_name</span><span class="o">=</span><span class="s2">&quot;pred&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ref&quot;</span><span class="p">:</span> <span class="n">ref_results</span><span class="p">,</span>
                  <span class="s2">&quot;pred&quot;</span><span class="p">:</span> <span class="n">pred_results</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">__calculate_intron_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This private method calculates the raw numbers regarding intron and intron chain statistics.</span>
<span class="sd">        :return: result_dictionary</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">intron_stats</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># Common, prediction, reference</span>

        <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">introns</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">introns</span><span class="p">[</span><span class="n">chrom</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">intron</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">introns</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">]:</span>
                    <span class="n">intron_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="mb">0b01</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">introns</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">intron</span><span class="p">])</span> <span class="o">&amp;</span> \
                                     <span class="p">((</span><span class="mb">0b10</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">introns</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">intron</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">intron_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="mb">0b10</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">introns</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">intron</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
                    <span class="n">intron_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mb">0b01</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">introns</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">intron</span><span class="p">]</span>

        <span class="c1"># Common, prediction, reference</span>
        <span class="n">intron_chains_nonred</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">intron_chains_common_ref</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">intron_chains_common_pred</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">intron_chains_pred</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">intron_chains_ref</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intron_chains</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intron_chains</span><span class="p">[</span><span class="n">chrom</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">intron_val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intron_chains</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intron_val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">intron_val</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">intron_chains_nonred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">intron_chains_common_ref</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">intron_val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">intron_chains_common_pred</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">intron_val</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="c1"># In reference</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intron_val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">intron_chains_nonred</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="c1"># intron_chains_ref_nonred += 1</span>
                        <span class="n">intron_chains_ref</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">intron_val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c1"># In prediction</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intron_val</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">intron_chains_nonred</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="c1"># intron_chains_pred_nonred += 1</span>
                        <span class="n">intron_chains_pred</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">intron_val</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">intron_chains_common_ref</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">intron_chains_common_ref</span><span class="p">)</span>
        <span class="n">intron_chains_common_pred</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">intron_chains_common_pred</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Intron chains:</span><span class="se">\</span>
<span class="s2">        </span><span class="se">\t</span><span class="s2">reference </span><span class="si">%d</span><span class="se">\t</span><span class="si">%d</span><span class="s2"></span>
<span class="s2">        </span><span class="se">\t</span><span class="s2">prediction</span><span class="se">\t</span><span class="si">%d</span><span class="s2"></span>
<span class="s2">        </span><span class="se">\t</span><span class="si">%d</span><span class="s2"></span>
<span class="s2">        </span><span class="se">\t</span><span class="s2">common</span><span class="se">\t</span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2"> </span><span class="si">%d</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
                          <span class="n">intron_chains_ref</span><span class="p">,</span>
                          <span class="n">intron_chains_nonred</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                          <span class="n">intron_chains_pred</span><span class="p">,</span>
                          <span class="n">intron_chains_nonred</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                          <span class="n">intron_chains_nonred</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="n">intron_chains_common_ref</span><span class="p">,</span>
                          <span class="n">intron_chains_common_pred</span><span class="p">)</span>

        <span class="n">result_dictionary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">result_dictionary</span><span class="p">[</span><span class="s2">&quot;introns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intron_stats</span>
        <span class="n">result_dictionary</span><span class="p">[</span><span class="s2">&quot;intron_chains&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">result_dictionary</span><span class="p">[</span><span class="s2">&quot;intron_chains&quot;</span><span class="p">][</span><span class="s2">&quot;non_redundant&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intron_chains_nonred</span>

        <span class="n">result_dictionary</span><span class="p">[</span><span class="s2">&quot;intron_chains&quot;</span><span class="p">][</span><span class="s2">&quot;redundant&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">intron_chains_common_pred</span><span class="p">,</span>
                                                           <span class="n">intron_chains_common_ref</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result_dictionary</span>

    <span class="k">def</span> <span class="nf">__extract_terminal_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_dictionary</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method to</span>
<span class="sd">        :param result_dictionary: the results dictionary</span>
<span class="sd">        :type result_dictionary: dict</span>
<span class="sd">        :return: updated result dictionary</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 0b000001: in reference</span>
        <span class="c1"># 0b000010: in prediction</span>
        <span class="c1"># 0b000100: single</span>
        <span class="c1"># 0b001000: internal</span>
        <span class="c1"># 0b010000: border</span>
        <span class="c1"># 0b100000: single match lenient</span>

        <span class="n">exon_common_lenient</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">exon_ref_lenient</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">exon_pred_lenient</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">chrom</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">]:</span>
                    <span class="n">exon_common_lenient</span> <span class="o">+=</span> <span class="p">(</span><span class="mb">0b1</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">start</span><span class="p">])</span> <span class="o">&amp;</span> \
                                           <span class="p">((</span><span class="mb">0b10</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">start</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">exon_ref_lenient</span> <span class="o">+=</span> <span class="mb">0b01</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">start</span><span class="p">]</span>
                    <span class="n">exon_pred_lenient</span> <span class="o">+=</span> <span class="p">(</span><span class="mb">0b10</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">start</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
        <span class="n">starts_common</span> <span class="o">=</span> <span class="n">exon_common_lenient</span>
        <span class="n">starts_ref</span> <span class="o">=</span> <span class="n">exon_ref_lenient</span>
        <span class="n">starts_pred</span> <span class="o">=</span> <span class="n">exon_pred_lenient</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starts </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">starts_common</span><span class="p">,</span> <span class="n">starts_ref</span><span class="p">,</span> <span class="n">starts_pred</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ends</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ends</span><span class="p">[</span><span class="n">chrom</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">end</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ends</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">]:</span>
                    <span class="n">exon_common_lenient</span> <span class="o">+=</span> <span class="p">(</span><span class="mb">0b01</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ends</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">end</span><span class="p">])</span> <span class="o">&amp;</span> \
                                           <span class="p">((</span><span class="mb">0b10</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ends</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">end</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">exon_ref_lenient</span> <span class="o">+=</span> <span class="mb">0b01</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ends</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">end</span><span class="p">]</span>
                    <span class="n">exon_pred_lenient</span> <span class="o">+=</span> <span class="p">(</span><span class="mb">0b10</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ends</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">end</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>

        <span class="n">ends_common</span> <span class="o">=</span> <span class="n">exon_common_lenient</span> <span class="o">-</span> <span class="n">starts_common</span>
        <span class="n">ends_ref</span> <span class="o">=</span> <span class="n">exon_ref_lenient</span> <span class="o">-</span> <span class="n">starts_ref</span>
        <span class="n">ends_pred</span> <span class="o">=</span> <span class="n">exon_pred_lenient</span> <span class="o">-</span> <span class="n">starts_pred</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ends </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">ends_common</span><span class="p">,</span> <span class="n">ends_ref</span><span class="p">,</span> <span class="n">ends_pred</span><span class="p">])</span>
        <span class="n">result_dictionary</span><span class="p">[</span><span class="s2">&quot;ends&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ends_common</span><span class="p">,</span> <span class="n">ends_pred</span><span class="p">,</span> <span class="n">ends_ref</span><span class="p">]</span>
        <span class="n">result_dictionary</span><span class="p">[</span><span class="s2">&quot;starts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">starts_common</span><span class="p">,</span> <span class="n">starts_pred</span><span class="p">,</span> <span class="n">starts_ref</span><span class="p">]</span>
        <span class="n">result_dictionary</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">result_dictionary</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">][</span><span class="s2">&quot;lenient&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">exon_common_lenient</span><span class="p">,</span>
                                                 <span class="n">exon_pred_lenient</span><span class="p">,</span>
                                                 <span class="n">exon_ref_lenient</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">result_dictionary</span>

    <span class="k">def</span> <span class="nf">__extract_internal_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_dictionary</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method that extracts the internal stats from the stored</span>
<span class="sd">        data and updates the result_dictionary dictionary.</span>
<span class="sd">        :param result_dictionary: the dictionary that stores the results</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Re-extract the previous stats</span>
        <span class="c1"># Common, prediction, reference</span>
        <span class="n">exon_lenient</span> <span class="o">=</span> <span class="n">result_dictionary</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">][</span><span class="s2">&quot;lenient&quot;</span><span class="p">]</span>

        <span class="c1"># Common, prediction, reference</span>
        <span class="n">bases</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Common, prediction, reference</span>
        <span class="n">exon_stringent</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">chrom</span><span class="p">]:</span>
                <span class="c1"># 0b000001: in reference</span>
                <span class="c1"># 0b000010: in prediction</span>
                <span class="c1"># 0b000100: single</span>
                <span class="c1"># 0b001000: internal</span>
                <span class="c1"># 0b010000: border</span>
                <span class="c1"># 0b100000: single match lenient</span>
                <span class="n">curr_pred_bases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">curr_ref_bases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">curr_exon</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">exon</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
                    <span class="c1"># Out of previous overlap</span>
                    <span class="k">if</span> <span class="n">exon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">curr_exon</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">bases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">curr_pred_bases</span><span class="p">,</span> <span class="n">curr_ref_bases</span><span class="p">))</span>
                        <span class="n">bases</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr_pred_bases</span><span class="p">)</span>
                        <span class="n">bases</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr_ref_bases</span><span class="p">)</span>
                        <span class="n">curr_exon</span> <span class="o">=</span> <span class="n">exon</span>
                        <span class="n">curr_pred_bases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="n">curr_ref_bases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">curr_exon</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_exon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exon</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="c1"># Exon is in reference</span>
                    <span class="k">if</span> <span class="p">(</span><span class="mb">0b01</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">])</span> <span class="o">==</span> <span class="mb">0b1</span><span class="p">:</span>
                        <span class="n">curr_ref_bases</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">exon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exon</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                        <span class="n">exon_stringent</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="c1"># Internal (first condition)</span>
                        <span class="c1"># OR</span>
                        <span class="c1"># Single exon</span>
                        <span class="k">if</span> <span class="p">(</span><span class="mb">0b001000</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">])</span> <span class="o">==</span> <span class="mb">0b001000</span><span class="p">:</span>
                            <span class="n">exon_lenient</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="mb">0b100000</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]:</span>
                            <span class="n">exon_lenient</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># Exon is in prediction</span>
                    <span class="k">if</span> <span class="p">(</span><span class="mb">0b10</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">])</span> <span class="o">==</span> <span class="mb">0b10</span><span class="p">:</span>
                        <span class="n">curr_pred_bases</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">exon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exon</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                        <span class="n">exon_stringent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="c1"># Either internal, or a single exon which</span>
                        <span class="c1"># has not a lenient single match with the reference annotation</span>
                        <span class="k">if</span> <span class="p">(</span><span class="mb">0b001000</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">])</span> <span class="o">==</span> <span class="mb">0b001000</span><span class="p">:</span>
                            <span class="n">exon_lenient</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="mb">0b100000</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]:</span>
                            <span class="n">exon_lenient</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># In both</span>
                    <span class="k">if</span> <span class="p">(</span><span class="mb">0b11</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">])</span> <span class="o">==</span> <span class="mb">0b11</span><span class="p">:</span>
                        <span class="n">exon_stringent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="p">(</span><span class="mb">0b001000</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">])</span> <span class="o">==</span> <span class="mb">0b001000</span><span class="p">:</span>
                            <span class="n">exon_lenient</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="mb">0b100000</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]:</span>
                            <span class="n">exon_lenient</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">bases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">curr_pred_bases</span><span class="p">,</span> <span class="n">curr_ref_bases</span><span class="p">))</span>
                <span class="n">bases</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr_pred_bases</span><span class="p">)</span>
                <span class="n">bases</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr_ref_bases</span><span class="p">)</span>

        <span class="c1"># result_dictionary[&quot;bases&quot;] = dict()</span>

        <span class="k">assert</span> <span class="n">bases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bases</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bases</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">bases</span>
        <span class="n">result_dictionary</span><span class="p">[</span><span class="s2">&quot;bases&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bases</span>
        <span class="n">result_dictionary</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">][</span><span class="s2">&quot;stringent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exon_stringent</span>
        <span class="n">result_dictionary</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">][</span><span class="s2">&quot;lenient&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exon_lenient</span>
        <span class="k">return</span> <span class="n">result_dictionary</span>

    <span class="k">def</span> <span class="nf">__calculate_exon_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This private method calculates the raw numbers regarding base and exon statistics.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__extract_terminal_stats</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__extract_internal_stats</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">__store_multiexonic_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transcr</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private procedure to store the results regarding a multiexonic</span>
<span class="sd">        transcript compared to the reference.</span>
<span class="sd">        :param transcr: a transcript instance</span>
<span class="sd">        :param strand: the strand to be used for storing</span>
<span class="sd">        :param result: a ResultStorer instance</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># assert transcr.monoexonic is False</span>
        <span class="n">ic_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">tuple</span><span class="p">([</span><span class="n">intron</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intron</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="k">for</span> <span class="n">intron</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">transcr</span><span class="o">.</span><span class="n">introns</span><span class="p">)])</span>
        <span class="c1"># if result.ccode == (&quot;=&quot;,):</span>
        <span class="c1">#     assert ic_key in self.intron_chains[transcr.chrom][strand]</span>
        <span class="c1">#     assert result.ref_id[0] in self.intron_chains[transcr.chrom][strand][ic_key][0]</span>

        <span class="k">if</span> <span class="n">ic_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intron_chains</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intron_chains</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">ic_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intron_chains</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">ic_key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">transcr</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">intron</span> <span class="ow">in</span> <span class="n">transcr</span><span class="o">.</span><span class="n">introns</span><span class="p">:</span>
            <span class="n">intron</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">intron</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intron</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">intron</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">introns</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">introns</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">intron</span><span class="p">]</span> <span class="o">=</span> <span class="mb">0b0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">introns</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">intron</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b10</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">exon</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transcr</span><span class="o">.</span><span class="n">exons</span><span class="p">):</span>
            <span class="n">exon</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">exon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exon</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">exon</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]</span> <span class="o">=</span> <span class="mb">0b0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b10</span>  <span class="c1"># set it as &quot;in prediction&quot;</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b010000</span>
                <span class="k">if</span> <span class="n">exon</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mb">0b0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">|=</span> <span class="mb">0b10</span>
            <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="n">transcr</span><span class="o">.</span><span class="n">exon_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b010000</span>
                <span class="k">if</span> <span class="n">exon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ends</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ends</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mb">0b00</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ends</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">|=</span> <span class="mb">0b10</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b01000</span>

    <span class="k">def</span> <span class="nf">__store_monoexonic_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transcr</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">ResultStorer</span><span class="p">,</span> <span class="n">other_exon</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private procedure to store the comparison of a monoexonic</span>
<span class="sd">        transcript with the reference.</span>
<span class="sd">        :param transcr: the monoexonic transcript</span>
<span class="sd">        :param strand: the strand to be used for storing</span>
<span class="sd">        :param other_exon: the reference exon this transcript is assigned to</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">transcr</span><span class="o">.</span><span class="n">monoexonic</span> <span class="ow">is</span> <span class="bp">True</span>
        <span class="n">exon</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">transcr</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">transcr</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">exon</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]</span> <span class="o">=</span> <span class="mb">0b0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">exon</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b100</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">ccode</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monoexonic_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">ref_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monoexonic_matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">transcr</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">other_exon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># other_exon = tuple([other_exon[0], other_exon[1]])</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other_exon</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">other_exon</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">],</span> <span class="p">(</span><span class="n">transcr</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                                     <span class="n">transcr</span><span class="o">.</span><span class="n">exons</span><span class="p">,</span>
                                                                     <span class="n">other_exon</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="mb">0b100</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">other_exon</span><span class="p">]:</span>
                <span class="c1"># Check the other exon is marked as single</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">other_exon</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b100</span>

            <span class="c1"># self.exons[transcr.chrom][strand][exon] |= 0b100000</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">][</span><span class="n">strand</span><span class="p">][</span><span class="n">other_exon</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b100000</span>

<div class="viewcode-block" id="Accountant.store"><a class="viewcode-back" href="../../../Mikado.scales.html#Mikado.scales.accountant.Accountant.store">[docs]</a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transcr</span><span class="p">:</span> <span class="n">Transcript</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">ResultStorer</span><span class="p">,</span> <span class="n">other_exon</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Add exons introns intron chains etc. to the storage.</span>
<span class="sd">        :param transcr: a &quot;Transcript&quot; instance</span>
<span class="sd">        :param result: Instance of &quot;result_storer&quot;</span>
<span class="sd">        :param other_exon: either None or an integer duplex</span>
<span class="sd">        :type other_exon: None | (int,int)</span>

<span class="sd">        A transcript is considered a perfect match if it has:</span>
<span class="sd">            junction_f1==100 and nucleotide_f1==100;</span>
<span class="sd">        a lenient match if it has junction_f1==100 and nucleotide_f1&gt;95,</span>
<span class="sd">        i.e. min(nucleotide_precision, nucleotide_recall)&gt;90.4</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">transcr</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_genes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pred_genes</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">transcr</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_genes</span><span class="p">[</span><span class="n">parent</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pred_genes</span><span class="p">[</span><span class="n">parent</span><span class="p">][</span><span class="n">transcr</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mb">0b1000</span>

        <span class="k">if</span> <span class="n">transcr</span><span class="o">.</span><span class="n">strand</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">strand</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strand</span> <span class="o">=</span> <span class="n">transcr</span><span class="o">.</span><span class="n">strand</span>

        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">ccode</span> <span class="o">!=</span> <span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">,):</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">transcr</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pred_genes</span><span class="p">[</span><span class="n">parent</span><span class="p">][</span><span class="n">transcr</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Clear the fourth bit</span>
            <span class="k">for</span> <span class="n">refid</span><span class="p">,</span> <span class="n">refgene</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">ref_id</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">ref_gene</span><span class="p">):</span>
                <span class="c1"># self.ref_genes[refgene][refid] |= 0b1000</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_genes</span><span class="p">[</span><span class="n">refgene</span><span class="p">][</span><span class="n">refid</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Clear the fourth bit</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">j_f1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">zipper</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">ref_id</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">ref_gene</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">j_f1</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">n_f1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">refid</span><span class="p">,</span> <span class="n">refgene</span><span class="p">,</span> <span class="n">junc_f1</span><span class="p">,</span> <span class="n">nucl_f1</span> <span class="ow">in</span> <span class="n">zipper</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">junc_f1</span> <span class="o">==</span> <span class="mi">100</span> <span class="ow">and</span> <span class="n">nucl_f1</span> <span class="o">&gt;=</span> <span class="mi">80</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">transcr</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">pred_genes</span><span class="p">[</span><span class="n">parent</span><span class="p">][</span><span class="n">transcr</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b100</span>
                            <span class="k">if</span> <span class="n">nucl_f1</span> <span class="o">&gt;=</span> <span class="mi">95</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">pred_genes</span><span class="p">[</span><span class="n">parent</span><span class="p">][</span><span class="n">transcr</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b10</span>
                            <span class="k">if</span> <span class="n">nucl_f1</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">pred_genes</span><span class="p">[</span><span class="n">parent</span><span class="p">][</span><span class="n">transcr</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b01</span>
                        <span class="c1"># Unset the &quot;private&quot; mark</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">ref_genes</span><span class="p">[</span><span class="n">refgene</span><span class="p">][</span><span class="n">refid</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b100</span>
                        <span class="k">if</span> <span class="n">nucl_f1</span> <span class="o">&gt;=</span> <span class="mi">95</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ref_genes</span><span class="p">[</span><span class="n">refgene</span><span class="p">][</span><span class="n">refid</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b10</span>
                        <span class="k">if</span> <span class="n">nucl_f1</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ref_genes</span><span class="p">[</span><span class="n">refgene</span><span class="p">][</span><span class="n">refid</span><span class="p">]</span> <span class="o">|=</span> <span class="mb">0b01</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">transcr</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pred_genes</span><span class="p">[</span><span class="n">parent</span><span class="p">][</span><span class="n">transcr</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mb">0b1000</span>

        <span class="k">if</span> <span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exons</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">()),</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">starts</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">()),</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ends</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">()),</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">introns</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">()),</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intron_chains</span><span class="p">[</span><span class="n">transcr</span><span class="o">.</span><span class="n">chrom</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">()),</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())])</span>

        <span class="k">if</span> <span class="n">transcr</span><span class="o">.</span><span class="n">exon_num</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__store_multiexonic_result</span><span class="p">(</span><span class="n">transcr</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__store_monoexonic_result</span><span class="p">(</span><span class="n">transcr</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">other_exon</span><span class="o">=</span><span class="n">other_exon</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__calculate_statistics</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to calculate precision, recall and F1 given</span>
<span class="sd">        the numbers in common, of the prediction, and of the reference</span>
<span class="sd">        :param common:</span>
<span class="sd">        :param pred:</span>
<span class="sd">        :param ref:</span>
<span class="sd">        :return: precision, recall, f1stat</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">ref</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">recall</span> <span class="o">=</span> <span class="n">common</span> <span class="o">/</span> <span class="n">ref</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">recall</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">pred</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="n">common</span> <span class="o">/</span> <span class="n">pred</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">f1stat</span> <span class="o">=</span> <span class="n">calc_f1</span><span class="p">(</span><span class="n">recall</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">f1stat</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__redundant_stats</span><span class="p">(</span><span class="n">common_pred</span><span class="p">,</span> <span class="n">common_ref</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to calculate precision, recall and F1 given the numbers of:</span>
<span class="sd">        - predictions which are matches</span>
<span class="sd">        - reference which are matches</span>
<span class="sd">        - total predictions</span>
<span class="sd">        - total references</span>

<span class="sd">        :param common_pred: number of predictions which are a match</span>
<span class="sd">        :param common_ref: number of references which are a match</span>
<span class="sd">        :param pred: total number of predictions</span>
<span class="sd">        :param ref: total number of references</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">ref</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">recall</span> <span class="o">=</span> <span class="n">common_ref</span> <span class="o">/</span> <span class="n">ref</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">recall</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">pred</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="n">common_pred</span> <span class="o">/</span> <span class="n">pred</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">f1stat</span> <span class="o">=</span> <span class="n">calc_f1</span><span class="p">(</span><span class="n">recall</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">f1stat</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__format_rowname</span><span class="p">(</span><span class="n">stru</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method to format the name of the rows in the stats table</span>
<span class="sd">        :param stru:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">total_length</span> <span class="o">=</span> <span class="mi">35</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">total_length</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">stru</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;{}:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stru</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__format_comparison_line</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">private</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to create the string that will be printed out to screen for the stats file.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">perc</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">private</span> <span class="o">/</span> <span class="n">total</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perc</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;{0} {1}/{2}  ({3:.2f}%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                                                  <span class="n">private</span><span class="p">,</span>
                                                  <span class="n">total</span><span class="p">,</span>
                                                  <span class="n">perc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">string</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__format_comparison_segments</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">private</span><span class="p">,</span> <span class="n">common</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to create the string that will be printed out to screen for the stats file.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">common</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">perc</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">private</span> <span class="o">-</span> <span class="n">common</span><span class="p">)</span> <span class="o">/</span> <span class="n">private</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perc</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;{0} {1}/{2}  ({3:.2f}%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                                                  <span class="n">private</span><span class="o">-</span><span class="n">common</span><span class="p">,</span>
                                                  <span class="n">private</span><span class="p">,</span>
                                                  <span class="n">perc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">string</span>

<div class="viewcode-block" id="Accountant.print_stats"><a class="viewcode-back" href="../../../Mikado.scales.html#Mikado.scales.accountant.Accountant.print_stats">[docs]</a>    <span class="k">def</span> <span class="nf">print_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method calculates and prints the final stats file.</span>
<span class="sd">        It is called when the prediction file</span>
<span class="sd">        parsing has been terminated correctly.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># num_ref_transcripts = sum(len(self.ref_genes[gid]) for gid in self.ref_genes)</span>
        <span class="c1"># num_pred_transcripts = sum(len(self.pred_genes[gid]) for gid in self.pred_genes)</span>

        <span class="c1"># Dictionary with the necessary data</span>
        <span class="n">bases_exon_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_exon_stats</span><span class="p">()</span>
        <span class="n">intron_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_intron_stats</span><span class="p">()</span>
        <span class="n">gene_transcript_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_gene_stats</span><span class="p">()</span>

        <span class="c1"># self.logger.debug(&quot;Missed exons lenient: %s&quot;, bases_exon_result[&quot;missed&quot;])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Exon stringent </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">bases_exon_result</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">][</span><span class="s2">&quot;stringent&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Exon lenient </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">bases_exon_result</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">][</span><span class="s2">&quot;lenient&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;Bases:</span>
<span class="sd">            \tcommon\t%d</span>
<span class="sd">            \tprediction\t%d</span>
<span class="sd">            \treference\t%d&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="o">*</span><span class="n">bases_exon_result</span><span class="p">[</span><span class="s2">&quot;bases&quot;</span><span class="p">])</span>

        <span class="n">bases_prec</span><span class="p">,</span> <span class="n">bases_recall</span><span class="p">,</span> <span class="n">bases_f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_statistics</span><span class="p">(</span>
            <span class="o">*</span><span class="n">bases_exon_result</span><span class="p">[</span><span class="s2">&quot;bases&quot;</span><span class="p">])</span>

        <span class="p">(</span><span class="n">exon_stringent_precision</span><span class="p">,</span> <span class="n">exon_stringent_recall</span><span class="p">,</span> <span class="n">exon_stringent_f1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_statistics</span><span class="p">(</span><span class="o">*</span><span class="n">bases_exon_result</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">][</span><span class="s2">&quot;stringent&quot;</span><span class="p">]))</span>

        <span class="p">(</span><span class="n">exon_lenient_precision</span><span class="p">,</span> <span class="n">exon_lenient_recall</span><span class="p">,</span> <span class="n">exon_lenient_f1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_statistics</span><span class="p">(</span><span class="o">*</span><span class="n">bases_exon_result</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">][</span><span class="s2">&quot;lenient&quot;</span><span class="p">]))</span>

        <span class="n">intron_precision</span><span class="p">,</span> <span class="n">intron_recall</span><span class="p">,</span> <span class="n">intron_f1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_statistics</span><span class="p">(</span>
            <span class="o">*</span><span class="n">intron_results</span><span class="p">[</span><span class="s2">&quot;introns&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">intron_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_statistics</span><span class="p">(</span>
            <span class="o">*</span><span class="n">intron_results</span><span class="p">[</span><span class="s2">&quot;intron_chains&quot;</span><span class="p">][</span><span class="s2">&quot;non_redundant&quot;</span><span class="p">])</span>

        <span class="n">intron_chains_precision</span><span class="p">,</span> <span class="n">intron_chains_recall</span><span class="p">,</span> <span class="n">intron_chains_f1</span> <span class="o">=</span> <span class="n">intron_stats</span>

        <span class="c1"># Transcript level</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="p">(</span><span class="n">tr_precision_stringent</span><span class="p">,</span> <span class="n">tr_recall_stringent</span><span class="p">,</span> <span class="n">tr_f1_stringent</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__redundant_stats</span><span class="p">(</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">][</span><span class="s2">&quot;stringent&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">][</span><span class="s2">&quot;stringent&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">],</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]))</span>

        <span class="p">(</span><span class="n">tr_precision_standard</span><span class="p">,</span> <span class="n">tr_recall_standard</span><span class="p">,</span> <span class="n">tr_f1_standard</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__redundant_stats</span><span class="p">(</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">][</span><span class="s2">&quot;standard&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">][</span><span class="s2">&quot;standard&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">],</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]))</span>

        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="p">(</span><span class="n">tr_precision_lenient</span><span class="p">,</span> <span class="n">tr_recall_lenient</span><span class="p">,</span> <span class="n">tr_f1_lenient</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__redundant_stats</span><span class="p">(</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">][</span><span class="s2">&quot;lenient&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">][</span><span class="s2">&quot;lenient&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">],</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]))</span>

        <span class="c1"># Gene level</span>
        <span class="n">ref_genes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_genes</span><span class="p">)</span>
        <span class="n">pred_genes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_genes</span><span class="p">)</span>
        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="p">(</span><span class="n">gene_precision_stringent</span><span class="p">,</span> <span class="n">gene_recall_stringent</span><span class="p">,</span> <span class="n">gene_f1_stringent</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__redundant_stats</span><span class="p">(</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">][</span><span class="s2">&quot;stringent&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">][</span><span class="s2">&quot;stringent&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">pred_genes</span><span class="p">,</span>
                <span class="n">ref_genes</span><span class="p">))</span>

        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="p">(</span><span class="n">gene_precision_standard</span><span class="p">,</span> <span class="n">gene_recall_standard</span><span class="p">,</span> <span class="n">gene_f1_standard</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__redundant_stats</span><span class="p">(</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">][</span><span class="s2">&quot;standard&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">][</span><span class="s2">&quot;standard&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">pred_genes</span><span class="p">,</span>
                <span class="n">ref_genes</span><span class="p">))</span>

        <span class="c1"># noinspection PyTypeChecker</span>
        <span class="p">(</span><span class="n">gene_precision_lenient</span><span class="p">,</span> <span class="n">gene_recall_lenient</span><span class="p">,</span> <span class="n">gene_f1_lenient</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__redundant_stats</span><span class="p">(</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">][</span><span class="s2">&quot;lenient&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">][</span><span class="s2">&quot;lenient&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">pred_genes</span><span class="p">,</span>
                <span class="n">ref_genes</span><span class="p">))</span>

        <span class="c1"># noinspection PyUnresolvedReferences</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;{0}.stats&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">out</span><span class="p">),</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>

            <span class="c1"># noinspection PyUnresolvedReferences</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Command line:</span><span class="se">\n</span><span class="s2">{0:&gt;10}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">commandline</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">],</span> <span class="s2">&quot;reference RNAs in&quot;</span><span class="p">,</span>
                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_genes</span><span class="p">),</span> <span class="s2">&quot;genes&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">],</span> <span class="s2">&quot;predicted RNAs in &quot;</span><span class="p">,</span>
                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_genes</span><span class="p">),</span> <span class="s2">&quot;genes&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">33</span><span class="p">,</span> <span class="s2">&quot;|   Sn |   Pr |   F1 |&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1:.2f}  {2:.2f}  {3:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Base level&quot;</span><span class="p">),</span>
                <span class="n">bases_recall</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">bases_prec</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">bases_f1</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1:.2f}  {2:.2f}  {3:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Exon level (stringent)&quot;</span><span class="p">),</span>
                <span class="n">exon_stringent_recall</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">exon_stringent_precision</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">exon_stringent_f1</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1:.2f}  {2:.2f}  {3:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Exon level (lenient)&quot;</span><span class="p">),</span>
                <span class="n">exon_lenient_recall</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">exon_lenient_precision</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">exon_lenient_f1</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1:.2f}  {2:.2f}  {3:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Intron level&quot;</span><span class="p">),</span>
                <span class="n">intron_recall</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">intron_precision</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">intron_f1</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1:.2f}  {2:.2f}  {3:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Intron chain level&quot;</span><span class="p">),</span>
                <span class="n">intron_chains_recall</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">intron_chains_precision</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">intron_chains_f1</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1:.2f}  {2:.2f}  {3:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Transcript level (stringent)&quot;</span><span class="p">),</span>
                <span class="n">tr_recall_stringent</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">tr_precision_stringent</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">tr_f1_stringent</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1:.2f}  {2:.2f}  {3:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Transcript level (&gt;=95% base F1)&quot;</span><span class="p">),</span>
                <span class="n">tr_recall_standard</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">tr_precision_standard</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">tr_f1_standard</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1:.2f}  {2:.2f}  {3:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Transcript level (&gt;=80% base F1)&quot;</span><span class="p">),</span>
                <span class="n">tr_recall_lenient</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">tr_precision_lenient</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">tr_f1_lenient</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1:.2f}  {2:.2f}  {3:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Gene level (100% base F1)&quot;</span><span class="p">),</span>
                <span class="n">gene_recall_stringent</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">gene_precision_stringent</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">gene_f1_stringent</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1:.2f}  {2:.2f}  {3:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Gene level (&gt;=95% base F1)&quot;</span><span class="p">),</span>
                <span class="n">gene_recall_standard</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">gene_precision_standard</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">gene_f1_standard</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1:.2f}  {2:.2f}  {3:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Gene level (&gt;=80% base F1)&quot;</span><span class="p">),</span>
                <span class="n">gene_recall_lenient</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">gene_precision_lenient</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">gene_f1_lenient</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Matching intron chains&quot;</span><span class="p">),</span>
                <span class="n">intron_results</span><span class="p">[</span><span class="s2">&quot;intron_chains&quot;</span><span class="p">][</span><span class="s2">&quot;redundant&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Matched intron chains&quot;</span><span class="p">),</span>
                <span class="n">intron_results</span><span class="p">[</span><span class="s2">&quot;intron_chains&quot;</span><span class="p">][</span><span class="s2">&quot;redundant&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Matching monoexonic transcripts&quot;</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monoexonic_matches</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Matched monoexonic transcripts&quot;</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monoexonic_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Total matching transcripts&quot;</span><span class="p">),</span>
                <span class="n">intron_results</span><span class="p">[</span><span class="s2">&quot;intron_chains&quot;</span><span class="p">][</span><span class="s2">&quot;redundant&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monoexonic_matches</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
                <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0} {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__format_rowname</span><span class="p">(</span><span class="s2">&quot;Total matched transcripts&quot;</span><span class="p">),</span>
                <span class="n">intron_results</span><span class="p">[</span><span class="s2">&quot;intron_chains&quot;</span><span class="p">][</span><span class="s2">&quot;redundant&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monoexonic_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
                <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__format_comparison_segments</span><span class="p">(</span><span class="s2">&quot;Missed exons (stringent)&quot;</span><span class="p">,</span>
                                                    <span class="n">bases_exon_result</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">][</span><span class="s2">&quot;stringent&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                                                    <span class="n">bases_exon_result</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">][</span><span class="s2">&quot;stringent&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                  <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__format_comparison_segments</span><span class="p">(</span><span class="s2">&quot;Novel exons (stringent)&quot;</span><span class="p">,</span>
                                                    <span class="n">bases_exon_result</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">][</span><span class="s2">&quot;stringent&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                                    <span class="n">bases_exon_result</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">][</span><span class="s2">&quot;stringent&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                  <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__format_comparison_segments</span><span class="p">(</span><span class="s2">&quot;Missed exons (lenient)&quot;</span><span class="p">,</span>
                                                    <span class="n">bases_exon_result</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">][</span><span class="s2">&quot;lenient&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                                                    <span class="n">bases_exon_result</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">][</span><span class="s2">&quot;lenient&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                  <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__format_comparison_segments</span><span class="p">(</span><span class="s2">&quot;Novel exons (lenient)&quot;</span><span class="p">,</span>
                                                    <span class="n">bases_exon_result</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">][</span><span class="s2">&quot;lenient&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                                    <span class="n">bases_exon_result</span><span class="p">[</span><span class="s2">&quot;exons&quot;</span><span class="p">][</span><span class="s2">&quot;lenient&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                  <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__format_comparison_segments</span><span class="p">(</span><span class="s2">&quot;Missed introns&quot;</span><span class="p">,</span>
                                                    <span class="n">intron_results</span><span class="p">[</span><span class="s2">&quot;introns&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                                                    <span class="n">intron_results</span><span class="p">[</span><span class="s2">&quot;introns&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                  <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__format_comparison_segments</span><span class="p">(</span><span class="s2">&quot;Novel introns&quot;</span><span class="p">,</span>
                                                    <span class="n">intron_results</span><span class="p">[</span><span class="s2">&quot;introns&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                                    <span class="n">intron_results</span><span class="p">[</span><span class="s2">&quot;introns&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                  <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

            <span class="c1"># noinspection PyTypeChecker</span>
            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__format_comparison_line</span><span class="p">(</span><span class="s2">&quot;Missed transcripts&quot;</span><span class="p">,</span>
                                                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">][</span><span class="s2">&quot;private&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]),</span>
                  <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

            <span class="c1"># noinspection PyTypeChecker</span>
            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__format_comparison_line</span><span class="p">(</span><span class="s2">&quot;Novel transcripts&quot;</span><span class="p">,</span>
                                                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">][</span><span class="s2">&quot;private&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]),</span>
                  <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

            <span class="c1"># noinspection PyTypeChecker</span>
            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__format_comparison_line</span><span class="p">(</span><span class="s2">&quot;Missed genes&quot;</span><span class="p">,</span>
                                                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">][</span><span class="s2">&quot;private&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_genes</span><span class="p">)),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

            <span class="c1"># noinspection PyTypeChecker</span>
            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__format_comparison_line</span><span class="p">(</span><span class="s2">&quot;Novel genes&quot;</span><span class="p">,</span>
                                                <span class="n">gene_transcript_results</span><span class="p">[</span><span class="s2">&quot;pred&quot;</span><span class="p">][</span><span class="s2">&quot;private&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_genes</span><span class="p">)),</span> <span class="nb">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue_handler</span><span class="p">)</span>
        <span class="c1"># self.queue_handler.close()</span>
        <span class="k">return</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Luca Venturini, Shabhonam Caim.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
  </body>
</html>